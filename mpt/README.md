# MPT节点

MPT树中的叶子节点和扩展节点都包含节点Key。在构建MPT树时，以半字节(nibble，4个bit)为单位查找多个Key的公共前缀和创建节点。为了方便对半字节的处理，及对节点类型的区分，以太坊黄皮书中设计了一种专门用于MPT树的HP（Hex-Prefix，十六进制前缀）编码，编码后的内容包含2部分：

l 前缀部分

前缀是半个字节，取值范围是0-3（含义如下表）

| <p><strong>半字节数量</strong></p><p><strong>节点类型</strong></p> | **奇数(1)**                             | **偶数(0)**                             |
| --------------------------------------------------------- | ------------------------------------- | ------------------------------------- |
| **叶子节点(2)**                                               | <p><strong>3</strong></p><p>(2+1)</p> | <p><strong>2</strong></p><p>(2+0)</p> |
| **非叶子节点(0)**                                              | <p><strong>1</strong></p><p>(0+1)</p> | <p><strong>0</strong></p><p>(0+0)</p> |

&#x20;

l 原文部分

原文包含N（整数）个半字节，HP编码对原文半字节个数的奇偶性是敏感的，对应2种不同的编码格式：

| **原文的半字节个数** | **HP编码字节数组**                                 |
| ------------ | -------------------------------------------- |
| 偶数           | \[ 前缀半字节（高位）,  (原文半字节 + 原文半字节),  ... ]       |
| 奇数           | \[ (前缀半字节 + 原文半字节),  (原文半字节 + 原文半字节),  ... ] |


# MPT树形数据结构

MPT（Merkle Patricia Tree）是一种的树形数据结构，用于32个字节(Key)与任意长度字节(Value)之间的映射，并提供持久化存储。MPT的节点种类分为：

| **节点种类**                              | **描述**                                           | **格式**                           |
| ------------------------------------- | ------------------------------------------------ | -------------------------------- |
| <p>叶子(Leaf)</p><p>KVNodeValue</p>     | <p>2项结构</p><p>Key - Value</p>                    | (Key, Value)                     |
| <p>扩展(Extension)</p><p>KVNodeNode</p> | <p>2项结构</p><p>Key - BranchNode</p>               | (Key, 分支节点)                      |
| <p>分支(Branch)</p><p>BranchNode</p>    | <p>17项结构</p><p>Node（2-16个）</p><p>Value（0-1个）</p> | \[节点（地址0-15）, 父级扩展节点Value（地址16）] |

注：MPT中Key的采用HP编码（详见TrieKey.java解读），Value采用RLP编码（原文为账户状态、交易、交易收据）。黄皮书从节点种类的角度定义了叶子、扩展、分支，但是用词上有些歧义，就“叶子”一词来讲，在树形数据结构的层级关系角度理解，通常表示节点位于分支的子级；但是从黄皮书定义节点种类来看，仅表示节点数据结构是Key-Value形式的2项结构，可以位于根部（当MPT仅存储一个对KV时），也可以作为根或分支部分的子级。所以，为了避免歧义，下文对节点种类的表示，将使用Java源代码中定义的枚举类型NodeType约定：KVNodeValue（叶子）、KVNodeNode（扩展）、BranchNode（分支），详见TrieImpl.java源代码（第64行）。

&#x20;

MPT在以太坊中的使用场景主要有3种：

| **树名称** | **使用场景**                     | **Key**                                   | **Value**                                   |
| ------- | ---------------------------- | ----------------------------------------- | ------------------------------------------- |
| 世界状态树   | 存储以太坊中所有账户的状态；生成世界状态树的根节点哈希值 | <p>账户地址</p><p>SHA3-256哈希值，32个字节</p>       | <p>账户状态(AccountState)</p><p>RLP编码</p>       |
| 交易树     | 生成区块中交易列表的根节点哈希值             | <p>交易在列表的索引(index)</p><p>RLP编码，1-4个字节</p> | <p>交易(Transaction)</p><p>RLP编码</p>          |
| 交易收据树   | 生成区块中交易收据列表的根节点哈希值           | <p>交易收据在列表的索引</p><p>RLP编码，1-4个字节</p>      | <p>交易收据(TransactionReceipt)</p><p>RLP编码</p> |

**世界状态树**

我们把以太坊比喻为一个世界的话，那么这个世界的起点便是创世区块（0号区块），最早一批进入这个世界的8893个原始居民（账户概念的比喻）便记录在创世区块中；然后，这个世界会不断进入新的居民，居民之间发生的经济活动（交易）推动着这个世界的繁荣增长。在以太坊中，从创世区块到最新区块的所有（非空）账户状态，都通过世界状态树进行存储。那么，我们从创世区块开始分析世界状态树的生成过程。

创世区块的配置文件路径：ethereumj/ethereumj-core/src/main/resources/genesis/frontier.json，其中alloc属性值是8893个账户的地址和余额信息。我们摘取前10个账户的配置信息，如下：

| <p>"alloc": {</p><p>    "3282791d6fd713f1e94f4bfd565eaa78b3a0599d": {</p><p>      "balance": "1337000000000000000000"</p><p>    },</p><p>    "17961d633bcf20a7b029a7d94b7df4da2ec5427f": {</p><p>      "balance": "229427000000000000000"</p><p>    },</p><p>    "493a67fe23decc63b10dda75f3287695a81bd5ab": {</p><p>      "balance": "880000000000000000000"</p><p>    },</p><p>    "01fb8ec12425a04f813e46c54c05748ca6b29aa9": {</p><p>      "balance": "259800000000000000000"</p><p>    },</p><p>    "d2a030ac8952325f9e1db378a71485a24e1b07b2": {</p><p>      "balance": "2000000000000000000000"</p><p>    },</p><p>    "77a34907f305a54c85db09c363fde3c47e6ae21f": {</p><p>      "balance": "985000000000000000000"</p><p>    },</p><p>    "391a77405c09a72b5e8436237aaaf95d68da1709": {</p><p>      "balance": "49082000000000000000"</p><p>    },</p><p>    "00aada25ea2286709abb422d41923fd380cd04c7": {</p><p>      "balance": "650100000000000000000"</p><p>    },</p><p>    "acc46a2a555c74ded4a2bd094e821b97843b40c0": {</p><p>      "balance": "1940000000000000000000"</p><p>    },</p><p>    "de07fb5b7a464e3ba7fbe09e9acb271af5338c58": {</p><p>      "balance": "50000000000000000000"</p><p>    },</p><p>    ...</p><p>}</p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

世界状态树的存储格式：Key是账户地址，Value是账户状态，笔者以第一个账户﻿为例介绍账户配置信息转为世界状态树存储格式的方式。

l 账户地址：

账户地址原值是20个字节：﻿3282791d6fd713f1e94f4bfd565eaa78b3a0599d，其SHA3-256哈希值是32个字节：4cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf7。

&#x20;

l 账户状态：

配置文件中只指定了账户余额为﻿1337000000000000000000（单位Wei），通过解读账户状态的源代码（AccountState.java），我们知道账户状态的属性列表如下：

| **属性名**                                         | **属性值**                                                           | **说明**                                      |
| ----------------------------------------------- | ----------------------------------------------------------------- | ------------------------------------------- |
| <p>nonce</p><p>外部账户地址发出的交易数量，或者合约账户所创建的合约数量</p> | 0                                                                 | <p>默认值</p><p>BigInteger类型</p>               |
| <p>﻿balance</p><p>账户余额</p>                      | ﻿1337000000000000000000                                           | 配置文件指定值                                     |
| <p>﻿stateRoot</p><p>合约账户内部存储的MPT树根节点</p>        | ﻿56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421 | <p>默认值</p><p>HashUtil.EMPTY_TRIE_HASH常量</p> |
| <p>﻿codeHash</p><p>合约账户的EVM代码的哈希值</p>           | ﻿c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470 | <p>默认值</p><p>HashUtil.EMPTY_DATA_HASH常量</p> |

此账户状态的RLP编码为：f84d8089487a9a304539440000a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470。

&#x20;

我们依照上述逻辑，将这10个账户的配置信息转换为世界状态树存储格式如下：

| **序号** | **账户地址（SHA3-256哈希值）**                                             | **账户状态（RLP编码）**                                                                                                                                                     |
| ------ | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | ﻿4cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf7 | ﻿f84d8089487a9a304539440000a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\[注] |
| 2      | ﻿fdacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c | ﻿f84d80890c6ff070f1938b8000...                                                                                                                                      |
| 3      | ﻿90a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa | ﻿f84d80892fb474098f67c00000...                                                                                                                                      |
| 4      | ﻿72e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c255 | ﻿f84d80890e15730385467c0000...                                                                                                                                      |
| 5      | ﻿68aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca478 | ﻿f84d80896c6b935b8bbd400000...                                                                                                                                      |
| 6      | ﻿d0d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c | ﻿f84d808935659ef93f0fc40000...                                                                                                                                      |
| 7      | ﻿43cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce318 | ﻿f84d808902a9264af3d1b90000...                                                                                                                                      |
| 8      | ﻿15b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d7672 | ﻿f84d8089233df3299f61720000...                                                                                                                                      |
| 9      | ﻿b2c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f38164257 | ﻿f84d8089692ae8897081d00000...                                                                                                                                      |
| 10     | ﻿15bff71a4221280c6999d26c1826d18c213240cd04766450b83e6f04ccfd4d5f | ﻿f84d808902b5e3af16b1880000...                                                                                                                                      |

注：下划线标注部分是stateRoot和codeHash属性的RLP编码，创世区块配置中所有账户的这2个属性都相同（取默认值），所以后续9个账户的此部分省略。

&#x20;

那么，世界状态MPT如何存储这些账户地址和账户状态的映射关系呢？我们通过分析MPT存储上述（创世区块配置中的前10个）账户的过程，来了解MPT的数据结构、处理逻辑。首先，MPT存储上述账户列表中第1个账户的地址和状态映射关系之后，MPT只包含一个KVNodeValue类型的节点，如下图：

&#x20;

![](<../.gitbook/assets/image (4).png>)

MPT节点列表如下：

| **层级**                                               | **节点类型**        | **节点Hash**                                                           | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                   | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | --------------- | -------------------------------------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **KVNodeValue** | **feae6ec4da4ae21c754ba7e1849979ebe7ab9e35ca99e59eb0ac1a1165f18f39** | **20**14cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72 | **f84d8089487a9a304539440000...**              |

注1：MPT存储了新的键值对（Key-Value）之后，树形数据结构会发生变化，为了方便阅读分析，我们给本章节中的MPT节点列表做一些约定：新的键值对通过“下划线”标记；新的键值对加入后发生变化（新增或修改）的节点，通过“加粗字体”进行标记。

注2：Key的HP编码分为两部分：

1HP编码的前缀部分，前缀半字节的4种状态及其含义：

&#x20; 3 - 叶子节点（KVNodeValue），原文部分奇数个半字节

&#x20; 2 - 叶子节点（KVNodeValue），原文部分偶数个半字节

&#x20; 1 - 扩展节点（KVNodeNode）或分支节点（BranchNode），原文部分奇数个半字节

&#x20; 0 - 扩展节点（KVNodeNode）或分支节点（BranchNode），原文部分偶数个半字节

当原文部分包含奇数个半字节时，前缀部分占半个字节。例如某节点的前缀部分为“3”时，按照上文所述的前缀半字节状态得知，此节点为包含奇数个原文半字节的叶子节点。

当原文部分包含偶数个半字节时，前缀部分占一个字节，即在前缀半字节之后补半个字节。例如某节点的前缀部分为“20”，高位半字节“2”表示此节点为包含偶数个原文半字节的叶子节点；低位半字节“0”是为了补齐字节而添加的，无特殊含义。

2HP编码的原文部分，MPT以半字节为单位处理Key，比如：将多个Key的相同高位半字节作为公共前缀；查找Key时，也是以半字节为单位进行匹配检索。账户地址SHA3-256哈希值，32个字节与64个半字节的对照关系如下：

![image](https://user-images.githubusercontent.com/4555304/152467085-19d1a6d2-6c06-4cc9-a8b9-0b8a88458b15.png)

&#x20;

MPT存储上述账户列表中第2个账户的地址和状态映射关系之后，呈现为2级树形数据结构，如下图：

&#x20;

![](<../.gitbook/assets/image (5).png>)

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                  | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                 | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                            | **de393b2e8310a2fd3b4fc15a0dceece1f9b7403fa8acda017a2897961411733c** |  ****    |  ****                                                                  |  ****                                          |
| <p><strong>2</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为4的子节点</strong></p>  | **c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe** | **4**    | **3**1cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72 | **f84d8089487a9a304539440000...**              |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为15的子节点</strong></p> | **9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc** | **f**    | **3**1dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2 | **f84d80890c6ff070f1938b8000...**              |

&#x20;

MPT存储上述账户列表中第3个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                 | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **db77f9c7cae85242118bcd4fb9a9864054a2cc9221340ea554953e21daf05b44** |  ****    |  ****                                                                  |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72     | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为9的子节点</strong></p> | **7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802** | **9**    | **3**10a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2 | **f84d80892fb474098f67c00000...**              |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2     | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第4个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **95f4022b7cb44f9340bc30917919abbe8ee61fe3e79447aa0befaf4a4a7e7700** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为7的子节点</strong></p> | **5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab** | **7**    | ﻿**3**12e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552 | ﻿**f84d80890e15730385467c0000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第5个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **fbfb2d2a2030f74895cc6665d25f892a4c1c8636bbce177e50a00cd4030f4b56** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为6的子节点</strong></p> | **e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6** | **6**    | ﻿**3**18aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782 | ﻿**f84d80896c6b935b8bbd400000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为7的子节点</p>                                   | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第6个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                  | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                            | **682515d7d6366140b650715dafca9683d67fe8aebb27aba4fdf83caf31e211a3** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                    | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为6的子节点</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为7的子节点</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为13的子节点</strong></p> | **cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d** | **d**    | ﻿**3**10d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2 | ﻿**f84d808935659ef93f0fc40000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第7个账户的地址和状态映射关系之后，呈现为3级树形数据结构，如下图：

&#x20;

![](<../.gitbook/assets/image (1).png>)

MPT节点列表如下：

| **层级**                                                | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ----------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong> </p><p><strong>根节点</strong></p> | **BranchNode**                                                              | **149bbcc1cbac0e95b577934fd0268b0510f8d909bedb67e35741f00057ef37cd** |  ****    |  ****                                                                   |  ****                                          |
| **2**                                                 | <p><strong>BranchNode</strong></p><p><strong>1级分支节点的子节点(地址4)</strong></p>   | **5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb** | **4**    |  ****                                                                   |  ****                                          |
| **3**                                                 | <p><strong>KVNodeValue</strong></p><p><strong>2级分支节点的子节点(地址3)</strong></p>  | **c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b** | **43**   | ﻿**20**1cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182 | ﻿**f84d808902a9264af3d1b90000...**             |
| **3**                                                 | <p><strong>KVNodeValue</strong></p><p><strong>2级分支节点的子节点(地址12)</strong></p> | **2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5** | **4c**   | **20**1fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72  | **f84d8089487a9a304539440000...**              |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第8个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                   | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>               | **6688a4fbd48c6cc70ba0a21064f526664b7695d530594696d7a336faf98c7f3a** |  ****    |  ****                                                                   |  ****                                          |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>1级分支节点的子节点(地址1)</strong></p> | **0b0cc7f8f60a824057490d7be714e6a7c731d74f0163475a31cc972a7b1c71d2** | **1**    | ﻿**3**15b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d76722 | ﻿**f84d8089233df3299f61720000...**             |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                    | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4        |                                                                         |                                                |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                   | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43       | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182     | ﻿f84d808902a9264af3d1b90000...                 |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                  | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c       | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                   | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                   | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                  | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第9个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>                | **6d63e1489104751a6ac53c8fb1eacda33af6c163936399bf3f4c7f1a61cfea26** |  ****    |  ****                                                                   |  ****                                          |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址1)</p>                                    | 0b0cc7f8f60a824057490d7be714e6a7c731d74f0163475a31cc972a7b1c71d2     | 1        | ﻿315b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d76722     | ﻿f84d8089233df3299f61720000...                 |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                     | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4        |                                                                         |                                                |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                    | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43       | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182     | ﻿f84d808902a9264af3d1b90000...                 |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                   | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c       | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>1级分支节点的子节点(地址11)</strong></p> | **3a5799d65bc9fa2105ae93e2446703f712f0ca8584e19e013ee18e15361e7924** | **b**    | ﻿**3**12c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f381642572 | ﻿**f84d8089692ae8897081d00000...**             |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第10个账户的地址和状态映射关系之后，呈现为4级树形数据结构（如下图）

&#x20;

![](<../.gitbook/assets/image (2).png>)

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀**  | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                    | <p><strong>Value</strong></p><p>账户状态的RLP编码</p>                                                                                   |
| ---------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | --------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>                | **127c2e65f524c8117840b3135280ee7084857d558b61da1798f587f81b10f9a6** |  ****     |  ****                                                                     |  ****                                                                                                                            |
| **2**                                                | <p><strong>KVNodeNode</strong></p><p><strong>1级分支节点的子节点(地址1)</strong></p>   | **47ad541c1b238dfdcac93b4df4b87da4858f1ee7a1dd292c899b65f1b1e42c38** | **1**     | **00**15b2                                                                | <p><strong>BranchNode</strong></p><p><strong>hash: 88359d34a15579992882d9c4fe49ae6a045f428f41c704734f5eb00c3563b509</strong></p> |
| **3**                                                | <p><strong>BranchNode</strong></p><p><strong>2级扩展节点的子节点</strong></p>        | **88359d34a15579992882d9c4fe49ae6a045f428f41c704734f5eb00c3563b509** | **15b**   |  ****                                                                     |  ****                                                                                                                            |
| **4**                                                | <p><strong>KVNodeValue</strong></p><p><strong>3级分支节点的子节点(地址4)</strong></p>  | **c24ee5d203c0012812ad5611807845f2e77d1f39fc5e6f756bccd58738a9432f** | ﻿**15b4** | ﻿**20**1f**4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d7672**2 | ﻿**f84d8089233df3299f61720000...**                                                                                               |
| **4**                                                | <p><strong>KVNodeValue</strong></p><p><strong>3级分支节点的子节点(地址15)</strong></p> | **3a22fed04f4d247eaf31fa57f74820cf812c8e2a3f072a8564e240ec6f980070** | **15bf**  | **20**1f71a4221280c6999d26c1826d18c213240cd04766450b83e6f04ccfd4d5f2      | ﻿**f84d808902b5e3af16b1880000...**                                                                                               |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                     | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4         |                                                                           |                                                                                                                                  |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                    | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43        | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182       | ﻿f84d808902a9264af3d1b90000...                                                                                                   |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                   | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c        | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72        | f84d8089487a9a304539440000...                                                                                                    |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6         | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782       | ﻿f84d80896c6b935b8bbd400000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7         | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552       | ﻿f84d80890e15730385467c0000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9         | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2        | f84d80892fb474098f67c00000...                                                                                                    |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址11)</p>                                   | 3a5799d65bc9fa2105ae93e2446703f712f0ca8584e19e013ee18e15361e7924     | b         | ﻿312c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f381642572       | ﻿f84d8089692ae8897081d00000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d         | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2       | ﻿f84d808935659ef93f0fc40000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f         | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2        | f84d80890c6ff070f1938b8000...                                                                                                    |

&#x20;

&#x20;

**交易树**

在打包区块时，通过按顺序存储交易列表生成交易MPT，并将交易MPT根节点的哈希值作为区块表头的一部分，用于校验区块所包含交易的顺序和交易内容的正确性。

我们用以太坊公链上第99975号区块（https://etherscan.io/block/99975）为例，分析交易树的生成过程（交易收据树的生成过程类似）。此区块的部分信息如下：

| **名称**                               | **数值**                                                             |
| ------------------------------------ | ------------------------------------------------------------------ |
| header.number（高度）                    | 99975                                                              |
| header.hash（区块哈希值）                   | 0x4e07c17a4d90c63c10f690b703a81e8ed466c44322c10385f8e6e22b2d4f3f1c |
| header.parentHash（父区块哈希值）            | 0xa5de830733da7e85eb6cd0e64a622912d4442fc550e2589a95980ee21260ddee |
| header.coinbase（矿工账户地址）              | 0xe6a7a1d47ff21b6321162aea7c6cb457d5476bca                         |
| header.stateRoot（世界状态树根节点哈希值）        | 0xf0c2dcd2c138f334314abbb789edff11fb09c4dfa4ef75fa7fc6c8a359b3afd4 |
| header.txTrieRoot（交易树根节点哈希值）         | 0x5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7 |
| header.receiptTrieRoot（交易收据树的根节点哈希值） | 0x26ce7f8c08057196028c61dd34e619495af969db5499257869af2308eaeb0051 |
| transactionsList（交易列表）的长度            | 3                                                                  |
| uncleList（叔父区块列表）的长度                 | 0                                                                  |

注：父区块的stateRoot为0xbc122eea2e0b706af9989fe9a7007ba4083def7288e0c3f0999794bdebb1280f，查询链接为https://www.etherchain.org/block/99974。

&#x20;

区块的交易列表：

| **地址** | **交易Hash**                                                       | **交易RLP编码**                                                                                                                                                                                                                        |
| ------ | ---------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | 530976b786ae456e4351efdcc9b4588c7b01ceb3692b4043015c22de094b3c88 | f86f820d7a850d08e3d6408255f0949cf18b3eb373c383a42d06136ba331d766ed9fbb8901f5f9d19bce273f80801ba051f96662142f93a5d25a2a765d71b1b35fa677436db14536d9c8aee3fbfd6dc4a06ce8d78f6db78a3b7d1b59416e6db82d94f3c9ab2e34a6ad7bf917af6796427a |
| 1      | 595f7b879ac916d5679a2321327b40eb570b511c9b64e84b213c31ed405b2957 | f86e820d7b850d08e3d6408255f094556ca325c21e450b2aff86d9c8ef0fa371971c978902033566cd0d830150801c9ff7cd5e2eb53b9839cd828e0bf6e1bcdd3a1d34bdc504b51ec5db1a47cc62cca0760d08cf9ad715108ebd6fa9380c6880d4f3c0508b3c2d9549309fd91196c108   |
| 2      | 2005c26a601571e47d7a5186d649a3a69893a55fe8fb6d44453d1278043bbe29 | f86f820d7c850d08e3d6408255f094c7704fc5c51c7a5f1a6574b0014b58c8915ba55c8902049c656e5cbc2780801ca07f838c11422af6c523aaf8e99db956046a9ea333abbf284eb266aed5995c580da056075bbefa3ea0d9b7397d835444cbd209e12e39485891dc400462619d787920 |

交易树的存储格式：Key是交易在列表的索引，Value是交易。我们将区块99975中的交易列表转换为交易树的存储格式，如下：

| **Key（交易索引的RLP编码）** | **Value（交易的RLP编码）** |
| ------------------- | ------------------- |
| 80                  | f86f82...427a       |
| 01                  | f86e82...c108       |
| 02                  | f86f82...7920       |

&#x20;

接下来，我们分析交易MPT存储交易列表的索引和交易的映射关系的过程，并获取交易MPT根节点的哈希值。首先，MPT存储上述交易列表中第1笔交易索引和交易内容映射关系之后，MPT只包含一个KVNodeValue类型的节点，其节点列表如下：

| **层级**                                               | **节点类型**        | **节点Hash**                                                           | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | --------------- | -------------------------------------------------------------------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **KVNodeValue** | **6d6c0a845495bf2aff74c735b40ed026604eeefddc9dca48739f3b7d66d18c10** | **20**1802                                   | **f86f82...427a**                              |

注：MPT存储了新的键值对（Key-Value）之后，树形数据结构会发生变化，为了方便阅读分析我们给MPT节点列表做一些约定：新的键值对通过“下划线”标记；新的键值对加入后发生变化（新增或修改）的节点，通过“加粗字体”进行标记。

&#x20;

MPT存储上述交易列表中第2笔交易的索引和交易内容映射关系之后，呈现为2级树形数据结构，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **c401504c735718855bf5bea0d2f67ce99bc747b6bfeef2e4a13313c5ad65e850** |  ****    |  ****                                        |  ****                                          |
| <p><strong>2</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为0的子节点</strong></p> | **c948825e22d66e1a660f16da6f876f14c34a6f7913338ce7bcef21ddfe420fb7** | **0**    | **3**112                                     | **f86e82...c108**                              |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为8的子节点</strong></p> | **04c7ab64f48c7de530a3b23d6c9a021de1df171783e07a44b56e1e8078d3001e** | **8**    | **3**102                                     | **f86f82...427a**                              |

&#x20;

MPT存储上述交易列表中第3笔交易的索引和交易内容映射关系之后，呈现为3级树形数据结构，如下图：

&#x20;

![](<../.gitbook/assets/image (3).png>)

&#x20;

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7** |  ****    |  ****                                        |  ****                                          |
| **2**                                                | **BranchNode**                                                           | **108a6d546ab2807f1d766632f1fe9b544eeac0102f5e30a23b14ef126333ec31** | **0**    |  ****                                        |  ****                                          |
| <p><strong>3</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为4的子节点</strong></p> | **04e90ac87d41b28532551838c7940dda08f366c1b0c4d832b6732dad209ac0d4** | **1**    | **20**1                                      | **f86e82...c108**                              |
| **3**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为9的子节点</strong></p> | **84342611d0e33c5f9c61322c170d639e51ee093ecfcc1cd3a9b9c474cc7235f2** | **2**    | **20**1                                      | **f86f82...7920**                              |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为8的子节点</p>                                   | 04c7ab64f48c7de530a3b23d6c9a021de1df171783e07a44b56e1e8078d3001e     | 8        | 3102                                         | f86f82...427a                                  |

&#x20;

最后，我们得到交易MPT的根节点BranchNode（Hash: 5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7），与以太坊公链的区块链浏览器中的区块信息一致（https://www.etherchain.org/block/99975）。



&#x20;
