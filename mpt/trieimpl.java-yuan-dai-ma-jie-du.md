# TrieImpl.java源代码解读

MPT（Merkle Patricia Tree）是一种的树形数据结构，用于32个字节(Key)与任意长度字节(Value)之间的映射，并提供持久化存储。MPT的节点种类分为：

| **节点种类**                              | **描述**                                           | **格式**                           |
| ------------------------------------- | ------------------------------------------------ | -------------------------------- |
| <p>叶子(Leaf)</p><p>KVNodeValue</p>     | <p>2项结构</p><p>Key - Value</p>                    | (Key, Value)                     |
| <p>扩展(Extension)</p><p>KVNodeNode</p> | <p>2项结构</p><p>Key - BranchNode</p>               | (Key, 分支节点)                      |
| <p>分支(Branch)</p><p>BranchNode</p>    | <p>17项结构</p><p>Node（2-16个）</p><p>Value（0-1个）</p> | \[节点（地址0-15）, 父级扩展节点Value（地址16）] |

注：MPT中Key的采用HP编码（详见TrieKey.java解读），Value采用RLP编码（原文为账户状态、交易、交易收据）。黄皮书从节点种类的角度定义了叶子、扩展、分支，但是用词上有些歧义，就“叶子”一词来讲，在树形数据结构的层级关系角度理解，通常表示节点位于分支的子级；但是从黄皮书定义节点种类来看，仅表示节点数据结构是Key-Value形式的2项结构，可以位于根部（当MPT仅存储一个对KV时），也可以作为根或分支部分的子级。所以，为了避免歧义，下文对节点种类的表示，将使用Java源代码中定义的枚举类型NodeType约定：KVNodeValue（叶子）、KVNodeNode（扩展）、BranchNode（分支），详见TrieImpl.java源代码（第64行）。

&#x20;

MPT在以太坊中的使用场景主要有3种：

| **树名称** | **使用场景**                     | **Key**                                   | **Value**                                   |
| ------- | ---------------------------- | ----------------------------------------- | ------------------------------------------- |
| 世界状态树   | 存储以太坊中所有账户的状态；生成世界状态树的根节点哈希值 | <p>账户地址</p><p>SHA3-256哈希值，32个字节</p>       | <p>账户状态(AccountState)</p><p>RLP编码</p>       |
| 交易树     | 生成区块中交易列表的根节点哈希值             | <p>交易在列表的索引(index)</p><p>RLP编码，1-4个字节</p> | <p>交易(Transaction)</p><p>RLP编码</p>          |
| 交易收据树   | 生成区块中交易收据列表的根节点哈希值           | <p>交易收据在列表的索引</p><p>RLP编码，1-4个字节</p>      | <p>交易收据(TransactionReceipt)</p><p>RLP编码</p> |

**世界状态树**

我们把以太坊比喻为一个世界的话，那么这个世界的起点便是创世区块（0号区块），最早一批进入这个世界的8893个原始居民（账户概念的比喻）便记录在创世区块中；然后，这个世界会不断进入新的居民，居民之间发生的经济活动（交易）推动着这个世界的繁荣增长。在以太坊中，从创世区块到最新区块的所有（非空）账户状态，都通过世界状态树进行存储。那么，我们从创世区块开始分析世界状态树的生成过程。

创世区块的配置文件路径：ethereumj/ethereumj-core/src/main/resources/genesis/frontier.json，其中alloc属性值是8893个账户的地址和余额信息。我们摘取前10个账户的配置信息，如下：

| <p>"alloc": {</p><p>    "3282791d6fd713f1e94f4bfd565eaa78b3a0599d": {</p><p>      "balance": "1337000000000000000000"</p><p>    },</p><p>    "17961d633bcf20a7b029a7d94b7df4da2ec5427f": {</p><p>      "balance": "229427000000000000000"</p><p>    },</p><p>    "493a67fe23decc63b10dda75f3287695a81bd5ab": {</p><p>      "balance": "880000000000000000000"</p><p>    },</p><p>    "01fb8ec12425a04f813e46c54c05748ca6b29aa9": {</p><p>      "balance": "259800000000000000000"</p><p>    },</p><p>    "d2a030ac8952325f9e1db378a71485a24e1b07b2": {</p><p>      "balance": "2000000000000000000000"</p><p>    },</p><p>    "77a34907f305a54c85db09c363fde3c47e6ae21f": {</p><p>      "balance": "985000000000000000000"</p><p>    },</p><p>    "391a77405c09a72b5e8436237aaaf95d68da1709": {</p><p>      "balance": "49082000000000000000"</p><p>    },</p><p>    "00aada25ea2286709abb422d41923fd380cd04c7": {</p><p>      "balance": "650100000000000000000"</p><p>    },</p><p>    "acc46a2a555c74ded4a2bd094e821b97843b40c0": {</p><p>      "balance": "1940000000000000000000"</p><p>    },</p><p>    "de07fb5b7a464e3ba7fbe09e9acb271af5338c58": {</p><p>      "balance": "50000000000000000000"</p><p>    },</p><p>    ...</p><p>}</p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

世界状态树的存储格式：Key是账户地址，Value是账户状态，笔者以第一个账户﻿为例介绍账户配置信息转为世界状态树存储格式的方式。

l 账户地址：

账户地址原值是20个字节：﻿3282791d6fd713f1e94f4bfd565eaa78b3a0599d，其SHA3-256哈希值是32个字节：4cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf7。

&#x20;

l 账户状态：

配置文件中只指定了账户余额为﻿1337000000000000000000（单位Wei），通过解读账户状态的源代码（AccountState.java），我们知道账户状态的属性列表如下：

| **属性名**                                         | **属性值**                                                           | **说明**                                      |
| ----------------------------------------------- | ----------------------------------------------------------------- | ------------------------------------------- |
| <p>nonce</p><p>外部账户地址发出的交易数量，或者合约账户所创建的合约数量</p> | 0                                                                 | <p>默认值</p><p>BigInteger类型</p>               |
| <p>﻿balance</p><p>账户余额</p>                      | ﻿1337000000000000000000                                           | 配置文件指定值                                     |
| <p>﻿stateRoot</p><p>合约账户内部存储的MPT树根节点</p>        | ﻿56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421 | <p>默认值</p><p>HashUtil.EMPTY_TRIE_HASH常量</p> |
| <p>﻿codeHash</p><p>合约账户的EVM代码的哈希值</p>           | ﻿c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470 | <p>默认值</p><p>HashUtil.EMPTY_DATA_HASH常量</p> |

此账户状态的RLP编码为：f84d8089487a9a304539440000a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470。

&#x20;

我们依照上述逻辑，将这10个账户的配置信息转换为世界状态树存储格式如下：

| **序号** | **账户地址（SHA3-256哈希值）**                                             | **账户状态（RLP编码）**                                                                                                                                                     |
| ------ | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | ﻿4cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf7 | ﻿f84d8089487a9a304539440000a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470\[注] |
| 2      | ﻿fdacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c | ﻿f84d80890c6ff070f1938b8000...                                                                                                                                      |
| 3      | ﻿90a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa | ﻿f84d80892fb474098f67c00000...                                                                                                                                      |
| 4      | ﻿72e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c255 | ﻿f84d80890e15730385467c0000...                                                                                                                                      |
| 5      | ﻿68aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca478 | ﻿f84d80896c6b935b8bbd400000...                                                                                                                                      |
| 6      | ﻿d0d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c | ﻿f84d808935659ef93f0fc40000...                                                                                                                                      |
| 7      | ﻿43cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce318 | ﻿f84d808902a9264af3d1b90000...                                                                                                                                      |
| 8      | ﻿15b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d7672 | ﻿f84d8089233df3299f61720000...                                                                                                                                      |
| 9      | ﻿b2c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f38164257 | ﻿f84d8089692ae8897081d00000...                                                                                                                                      |
| 10     | ﻿15bff71a4221280c6999d26c1826d18c213240cd04766450b83e6f04ccfd4d5f | ﻿f84d808902b5e3af16b1880000...                                                                                                                                      |

注：下划线标注部分是stateRoot和codeHash属性的RLP编码，创世区块配置中所有账户的这2个属性都相同（取默认值），所以后续9个账户的此部分省略。

&#x20;

那么，世界状态MPT如何存储这些账户地址和账户状态的映射关系呢？我们通过分析MPT存储上述（创世区块配置中的前10个）账户的过程，来了解MPT的数据结构、处理逻辑。首先，MPT存储上述账户列表中第1个账户的地址和状态映射关系之后，MPT只包含一个KVNodeValue类型的节点，如下图：

&#x20;

MPT节点列表如下：

| **层级**                                               | **节点类型**        | **节点Hash**                                                           | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                   | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | --------------- | -------------------------------------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **KVNodeValue** | **feae6ec4da4ae21c754ba7e1849979ebe7ab9e35ca99e59eb0ac1a1165f18f39** | **20**14cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72 | **f84d8089487a9a304539440000...**              |

注1：MPT存储了新的键值对（Key-Value）之后，树形数据结构会发生变化，为了方便阅读分析，我们给本章节中的MPT节点列表做一些约定：新的键值对通过“下划线”标记；新的键值对加入后发生变化（新增或修改）的节点，通过“加粗字体”进行标记。

注2：Key的HP编码分为两部分：

1HP编码的前缀部分，前缀半字节的4种状态及其含义：

&#x20; 3 - 叶子节点（KVNodeValue），原文部分奇数个半字节

&#x20; 2 - 叶子节点（KVNodeValue），原文部分偶数个半字节

&#x20; 1 - 扩展节点（KVNodeNode）或分支节点（BranchNode），原文部分奇数个半字节

&#x20; 0 - 扩展节点（KVNodeNode）或分支节点（BranchNode），原文部分偶数个半字节

当原文部分包含奇数个半字节时，前缀部分占半个字节。例如某节点的前缀部分为“3”时，按照上文所述的前缀半字节状态得知，此节点为包含奇数个原文半字节的叶子节点。

当原文部分包含偶数个半字节时，前缀部分占一个字节，即在前缀半字节之后补半个字节。例如某节点的前缀部分为“20”，高位半字节“2”表示此节点为包含偶数个原文半字节的叶子节点；低位半字节“0”是为了补齐字节而添加的，无特殊含义。

2HP编码的原文部分，MPT以半字节为单位处理Key，比如：将多个Key的相同高位半字节作为公共前缀；查找Key时，也是以半字节为单位进行匹配检索。账户地址SHA3-256哈希值，32个字节与64个半字节的对照关系如下：

| **高位字节**                                                                                                                                                     | **低位字节** |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| 1   2    3   4   5    6   7    8   9   10  11   12  13  14   15  16  17   18  19  20   21  22   23  24  25  26  27  28   29  30  31  32                      |          |
| 4c fa 59 d6 1b af 3a d9 04 b3 ee 77 7a f9 ea 42 8f 45 76 45 92 ab 9d 8c 18 b7 9c c1 6d 46 dc f7                                                              |          |

&#x20;

| **高位半字节**                                                                                                                                                              | **低位半字节** |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| 1  2  3  4  5  6  7  8  9  10    12  14  16  18   20  22   24  26  28   30  32  34   36  38  40   42  44   46  48  50  52 54  56   58  60  62  64                      |           |
| 4 c f a 5 9 d 6 1 b a f 3 a d 9 0 4 b 3 e e 7 7 7 a f 9 e a 4 2 8 f 4 5 7 6 4 5 9 2 a b 9 d 8 c 1 8 b 7 9 c c 1 6 d 4 6 d c f 7                                        |           |
|                                                                                                                                                                        |           |

&#x20;

MPT存储上述账户列表中第2个账户的地址和状态映射关系之后，呈现为2级树形数据结构，如下图：

&#x20;

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                  | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                 | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                            | **de393b2e8310a2fd3b4fc15a0dceece1f9b7403fa8acda017a2897961411733c** |  ****    |  ****                                                                  |  ****                                          |
| <p><strong>2</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为4的子节点</strong></p>  | **c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe** | **4**    | **3**1cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72 | **f84d8089487a9a304539440000...**              |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为15的子节点</strong></p> | **9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc** | **f**    | **3**1dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2 | **f84d80890c6ff070f1938b8000...**              |

&#x20;

MPT存储上述账户列表中第3个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                 | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **db77f9c7cae85242118bcd4fb9a9864054a2cc9221340ea554953e21daf05b44** |  ****    |  ****                                                                  |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72     | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为9的子节点</strong></p> | **7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802** | **9**    | **3**10a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2 | **f84d80892fb474098f67c00000...**              |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2     | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第4个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **95f4022b7cb44f9340bc30917919abbe8ee61fe3e79447aa0befaf4a4a7e7700** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为7的子节点</strong></p> | **5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab** | **7**    | ﻿**3**12e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552 | ﻿**f84d80890e15730385467c0000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第5个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **fbfb2d2a2030f74895cc6665d25f892a4c1c8636bbce177e50a00cd4030f4b56** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                   | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为6的子节点</strong></p> | **e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6** | **6**    | ﻿**3**18aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782 | ﻿**f84d80896c6b935b8bbd400000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为7的子节点</p>                                   | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第6个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                  | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                            | **682515d7d6366140b650715dafca9683d67fe8aebb27aba4fdf83caf31e211a3** |  ****    |  ****                                                                   |  ****                                          |
| <p>2</p><p> </p>                                     | <p>KVNodeValue</p><p>分支节点中地址为4的子节点</p>                                    | c0a173198ac93a058bcbd2085e212189a382d34868b68c6c8b4feec8bce274fe     | 4        | 31cfa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为6的子节点</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为7的子节点</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为9的子节点</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为13的子节点</strong></p> | **cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d** | **d**    | ﻿**3**10d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2 | ﻿**f84d808935659ef93f0fc40000...**             |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为15的子节点</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第7个账户的地址和状态映射关系之后，呈现为3级树形数据结构，如下图：

&#x20;

MPT节点列表如下：

| **层级**                                                | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ----------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong> </p><p><strong>根节点</strong></p> | **BranchNode**                                                              | **149bbcc1cbac0e95b577934fd0268b0510f8d909bedb67e35741f00057ef37cd** |  ****    |  ****                                                                   |  ****                                          |
| **2**                                                 | <p><strong>BranchNode</strong></p><p><strong>1级分支节点的子节点(地址4)</strong></p>   | **5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb** | **4**    |  ****                                                                   |  ****                                          |
| **3**                                                 | <p><strong>KVNodeValue</strong></p><p><strong>2级分支节点的子节点(地址3)</strong></p>  | **c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b** | **43**   | ﻿**20**1cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182 | ﻿**f84d808902a9264af3d1b90000...**             |
| **3**                                                 | <p><strong>KVNodeValue</strong></p><p><strong>2级分支节点的子节点(地址12)</strong></p> | **2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5** | **4c**   | **20**1fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72  | **f84d8089487a9a304539440000...**              |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                     | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第8个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                   | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>               | **6688a4fbd48c6cc70ba0a21064f526664b7695d530594696d7a336faf98c7f3a** |  ****    |  ****                                                                   |  ****                                          |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>1级分支节点的子节点(地址1)</strong></p> | **0b0cc7f8f60a824057490d7be714e6a7c731d74f0163475a31cc972a7b1c71d2** | **1**    | ﻿**3**15b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d76722 | ﻿**f84d8089233df3299f61720000...**             |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                    | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4        |                                                                         |                                                |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                   | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43       | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182     | ﻿f84d808902a9264af3d1b90000...                 |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                  | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c       | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                   | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                   | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                   | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                  | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                  | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第9个账户的地址和状态映射关系之后，其节点列表如下：

| **层级**                                               | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                  | <p><strong>Value</strong></p><p>账户状态的RLP编码</p> |
| ---------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>                | **6d63e1489104751a6ac53c8fb1eacda33af6c163936399bf3f4c7f1a61cfea26** |  ****    |  ****                                                                   |  ****                                          |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址1)</p>                                    | 0b0cc7f8f60a824057490d7be714e6a7c731d74f0163475a31cc972a7b1c71d2     | 1        | ﻿315b4f4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d76722     | ﻿f84d8089233df3299f61720000...                 |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                     | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4        |                                                                         |                                                |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                    | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43       | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182     | ﻿f84d808902a9264af3d1b90000...                 |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                   | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c       | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72      | f84d8089487a9a304539440000...                  |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6        | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782     | ﻿f84d80896c6b935b8bbd400000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7        | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552     | ﻿f84d80890e15730385467c0000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9        | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2      | f84d80892fb474098f67c00000...                  |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>1级分支节点的子节点(地址11)</strong></p> | **3a5799d65bc9fa2105ae93e2446703f712f0ca8584e19e013ee18e15361e7924** | **b**    | ﻿**3**12c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f381642572 | ﻿**f84d8089692ae8897081d00000...**             |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d        | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2     | ﻿f84d808935659ef93f0fc40000...                 |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f        | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2      | f84d80890c6ff070f1938b8000...                  |

&#x20;

MPT存储上述账户列表中第10个账户的地址和状态映射关系之后，呈现为4级树形数据结构（如下图）

&#x20;

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                    | **节点Hash**                                                           | **公共前缀**  | <p><strong>Key</strong></p><p>账户地址SHA3-256哈希值的HP编码</p>                    | <p><strong>Value</strong></p><p>账户状态的RLP编码</p>                                                                                   |
| ---------------------------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------------------------- | --------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | <p><strong>BranchNode</strong></p><p> <strong></strong> </p>                | **127c2e65f524c8117840b3135280ee7084857d558b61da1798f587f81b10f9a6** |  ****     |  ****                                                                     |  ****                                                                                                                            |
| **2**                                                | <p><strong>KVNodeNode</strong></p><p><strong>1级分支节点的子节点(地址1)</strong></p>   | **47ad541c1b238dfdcac93b4df4b87da4858f1ee7a1dd292c899b65f1b1e42c38** | **1**     | **00**15b2                                                                | <p><strong>BranchNode</strong></p><p><strong>hash: 88359d34a15579992882d9c4fe49ae6a045f428f41c704734f5eb00c3563b509</strong></p> |
| **3**                                                | <p><strong>BranchNode</strong></p><p><strong>2级扩展节点的子节点</strong></p>        | **88359d34a15579992882d9c4fe49ae6a045f428f41c704734f5eb00c3563b509** | **15b**   |  ****                                                                     |  ****                                                                                                                            |
| **4**                                                | <p><strong>KVNodeValue</strong></p><p><strong>3级分支节点的子节点(地址4)</strong></p>  | **c24ee5d203c0012812ad5611807845f2e77d1f39fc5e6f756bccd58738a9432f** | ﻿**15b4** | ﻿**20**1f**4f04b628809e9d79e705845bdbd5803a898cf7ced39cf51b0bf338d7672**2 | ﻿**f84d8089233df3299f61720000...**                                                                                               |
| **4**                                                | <p><strong>KVNodeValue</strong></p><p><strong>3级分支节点的子节点(地址15)</strong></p> | **3a22fed04f4d247eaf31fa57f74820cf812c8e2a3f072a8564e240ec6f980070** | **15bf**  | **20**1f71a4221280c6999d26c1826d18c213240cd04766450b83e6f04ccfd4d5f2      | ﻿**f84d808902b5e3af16b1880000...**                                                                                               |
| 2                                                    | <p>BranchNode</p><p>1级分支节点的子节点(地址4)</p>                                     | 5f69b5005db30fe95000ba06a3c4f46235f477d2454aafbb2f0d2ff5d739fbcb     | 4         |                                                                           |                                                                                                                                  |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址3)</p>                                    | c79e1688ad960f855f501b478c86146ccaef829e55a7ae1e2ce4bfe882283d5b     | 43        | ﻿201cd950398fbeacec9a8e4fa6c167691bdf78abf7ed6ef76bbe75aad85dce3182       | ﻿f84d808902a9264af3d1b90000...                                                                                                   |
| 3                                                    | <p>KVNodeValue</p><p>2级分支节点的子节点(地址12)</p>                                   | 2af685b8441706d3b146458c3fd6a738a010dca3ba59d9346c86598767e8aff5     | 4c        | 201fa59d61baf3ad904b3ee777af9ea428f45764592ab9d8c18b79cc16d46dcf72        | f84d8089487a9a304539440000...                                                                                                    |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址6)</p>                                    | e2c9a75dba850b87977d721bdeb219d159096e19d26bcb1ce24d39d79a91d4a6     | 6         | ﻿318aaa6156657b86d0f9a824dade1e97905f651d2a90a0e8d4505d2dd035ca4782       | ﻿f84d80896c6b935b8bbd400000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址7)</p>                                    | 5a4631dbb2ac752597ffec43d92a1c81b1e53aee9527245a57c161e1f9630aab     | 7         | ﻿312e6ec6365d5c8c8344872a0d5b228aa211e156e245c6d8921c7e709f088c2552       | ﻿f84d80890e15730385467c0000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址9)</p>                                    | 7a342ee12204baad17f5c8a3d1c0c9e50ede2f5ce7974eab2f8fd928f57be802     | 9         | 310a19b0327a6755de57def38c0143181badaf87eaa9b2f642c1263cf127f4aaa2        | f84d80892fb474098f67c00000...                                                                                                    |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址11)</p>                                   | 3a5799d65bc9fa2105ae93e2446703f712f0ca8584e19e013ee18e15361e7924     | b         | ﻿312c70f5a496e645bb551577fd16386258d4c4b65a4ab8af85cd3703f381642572       | ﻿f84d8089692ae8897081d00000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址13)</p>                                   | cbcd28101994b513a18de29536b33b8bc14ebd39a473bece218d7bd03bdf978d     | d         | ﻿310d141107dca86409dd8f9fff40e8bb0a1a497a4e55e4978bc317cc8f8ec011c2       | ﻿f84d808935659ef93f0fc40000...                                                                                                   |
| 2                                                    | <p>KVNodeValue</p><p>1级分支节点的子节点(地址15)</p>                                   | 9effd7b15b301fc33b2c61fa7232016cff1c430ea7745e232beff90e2d8692bc     | f         | 31dacc5d91e62f22144786d5107e64c2f0f5407fca3150d9c5fc4cb6760d8f69c2        | f84d80890c6ff070f1938b8000...                                                                                                    |

&#x20;

&#x20;

**交易树**

在打包区块时，通过按顺序存储交易列表生成交易MPT，并将交易MPT根节点的哈希值作为区块表头的一部分，用于校验区块所包含交易的顺序和交易内容的正确性。

我们用以太坊公链上第99975号区块（https://etherscan.io/block/99975）为例，分析交易树的生成过程（交易收据树的生成过程类似）。此区块的部分信息如下：

| **名称**                               | **数值**                                                             |
| ------------------------------------ | ------------------------------------------------------------------ |
| header.number（高度）                    | 99975                                                              |
| header.hash（区块哈希值）                   | 0x4e07c17a4d90c63c10f690b703a81e8ed466c44322c10385f8e6e22b2d4f3f1c |
| header.parentHash（父区块哈希值）            | 0xa5de830733da7e85eb6cd0e64a622912d4442fc550e2589a95980ee21260ddee |
| header.coinbase（矿工账户地址）              | 0xe6a7a1d47ff21b6321162aea7c6cb457d5476bca                         |
| header.stateRoot（世界状态树根节点哈希值）        | 0xf0c2dcd2c138f334314abbb789edff11fb09c4dfa4ef75fa7fc6c8a359b3afd4 |
| header.txTrieRoot（交易树根节点哈希值）         | 0x5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7 |
| header.receiptTrieRoot（交易收据树的根节点哈希值） | 0x26ce7f8c08057196028c61dd34e619495af969db5499257869af2308eaeb0051 |
| transactionsList（交易列表）的长度            | 3                                                                  |
| uncleList（叔父区块列表）的长度                 | 0                                                                  |

注：父区块的stateRoot为0xbc122eea2e0b706af9989fe9a7007ba4083def7288e0c3f0999794bdebb1280f，查询链接为https://www.etherchain.org/block/99974。

&#x20;

区块的交易列表：

| **地址** | **交易Hash**                                                       | **交易RLP编码**                                                                                                                                                                                                                        |
| ------ | ---------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | 530976b786ae456e4351efdcc9b4588c7b01ceb3692b4043015c22de094b3c88 | f86f820d7a850d08e3d6408255f0949cf18b3eb373c383a42d06136ba331d766ed9fbb8901f5f9d19bce273f80801ba051f96662142f93a5d25a2a765d71b1b35fa677436db14536d9c8aee3fbfd6dc4a06ce8d78f6db78a3b7d1b59416e6db82d94f3c9ab2e34a6ad7bf917af6796427a |
| 1      | 595f7b879ac916d5679a2321327b40eb570b511c9b64e84b213c31ed405b2957 | f86e820d7b850d08e3d6408255f094556ca325c21e450b2aff86d9c8ef0fa371971c978902033566cd0d830150801c9ff7cd5e2eb53b9839cd828e0bf6e1bcdd3a1d34bdc504b51ec5db1a47cc62cca0760d08cf9ad715108ebd6fa9380c6880d4f3c0508b3c2d9549309fd91196c108   |
| 2      | 2005c26a601571e47d7a5186d649a3a69893a55fe8fb6d44453d1278043bbe29 | f86f820d7c850d08e3d6408255f094c7704fc5c51c7a5f1a6574b0014b58c8915ba55c8902049c656e5cbc2780801ca07f838c11422af6c523aaf8e99db956046a9ea333abbf284eb266aed5995c580da056075bbefa3ea0d9b7397d835444cbd209e12e39485891dc400462619d787920 |

交易树的存储格式：Key是交易在列表的索引，Value是交易。我们将区块99975中的交易列表转换为交易树的存储格式，如下：

| **Key（交易索引的RLP编码）** | **Value（交易的RLP编码）** |
| ------------------- | ------------------- |
| 80                  | f86f82...427a       |
| 01                  | f86e82...c108       |
| 02                  | f86f82...7920       |

&#x20;

接下来，我们分析交易MPT存储交易列表的索引和交易的映射关系的过程，并获取交易MPT根节点的哈希值。首先，MPT存储上述交易列表中第1笔交易索引和交易内容映射关系之后，MPT只包含一个KVNodeValue类型的节点，其节点列表如下：

| **层级**                                               | **节点类型**        | **节点Hash**                                                           | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | --------------- | -------------------------------------------------------------------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **KVNodeValue** | **6d6c0a845495bf2aff74c735b40ed026604eeefddc9dca48739f3b7d66d18c10** | **20**1802                                   | **f86f82...427a**                              |

注：MPT存储了新的键值对（Key-Value）之后，树形数据结构会发生变化，为了方便阅读分析我们给MPT节点列表做一些约定：新的键值对通过“下划线”标记；新的键值对加入后发生变化（新增或修改）的节点，通过“加粗字体”进行标记。

&#x20;

MPT存储上述交易列表中第2笔交易的索引和交易内容映射关系之后，呈现为2级树形数据结构，其节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **c401504c735718855bf5bea0d2f67ce99bc747b6bfeef2e4a13313c5ad65e850** |  ****    |  ****                                        |  ****                                          |
| <p><strong>2</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为0的子节点</strong></p> | **c948825e22d66e1a660f16da6f876f14c34a6f7913338ce7bcef21ddfe420fb7** | **0**    | **3**112                                     | **f86e82...c108**                              |
| **2**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为8的子节点</strong></p> | **04c7ab64f48c7de530a3b23d6c9a021de1df171783e07a44b56e1e8078d3001e** | **8**    | **3**102                                     | **f86f82...427a**                              |

&#x20;

MPT存储上述交易列表中第3笔交易的索引和交易内容映射关系之后，呈现为3级树形数据结构，如下图：

&#x20;

&#x20;

MPT节点列表如下：

| **层级**                                               | **节点类型**                                                                 | **节点Hash**                                                           | **公共前缀** | <p><strong>Key</strong></p><p>交易索引的RLP编码</p> | <p><strong>Value</strong></p><p>交易内容的RLP编码</p> |
| ---------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------- | -------------------------------------------- | ---------------------------------------------- |
| <p><strong>1</strong></p><p><strong>根节点</strong></p> | **BranchNode**                                                           | **5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7** |  ****    |  ****                                        |  ****                                          |
| **2**                                                | **BranchNode**                                                           | **108a6d546ab2807f1d766632f1fe9b544eeac0102f5e30a23b14ef126333ec31** | **0**    |  ****                                        |  ****                                          |
| <p><strong>3</strong></p><p> <strong></strong> </p>  | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为4的子节点</strong></p> | **04e90ac87d41b28532551838c7940dda08f366c1b0c4d832b6732dad209ac0d4** | **1**    | **20**1                                      | **f86e82...c108**                              |
| **3**                                                | <p><strong>KVNodeValue</strong></p><p><strong>分支节点中地址为9的子节点</strong></p> | **84342611d0e33c5f9c61322c170d639e51ee093ecfcc1cd3a9b9c474cc7235f2** | **2**    | **20**1                                      | **f86f82...7920**                              |
| 2                                                    | <p>KVNodeValue</p><p>分支节点中地址为8的子节点</p>                                   | 04c7ab64f48c7de530a3b23d6c9a021de1df171783e07a44b56e1e8078d3001e     | 8        | 3102                                         | f86f82...427a                                  |

&#x20;

最后，我们得到交易MPT的根节点BranchNode（Hash: 5118c78d2f2f0ef8a59ca105b56b0da8bb6447a3380730c47da54b89374427d7），与以太坊公链的区块链浏览器中的区块信息一致（https://www.etherchain.org/block/99975）。

![](file:///private/var/folders/9y/x\_9ztblj0vb1mymmld\_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps3Z4zy4.jpg)&#x20;

\


| <p>18. <strong>package org.ethereum.trie;</strong></p><p>19. <strong></strong> </p><p>20. <strong>import com.google.common.util.concurrent.ThreadFactoryBuilder;</strong></p><p>21. <strong>import org.apache.commons.lang3.text.StrBuilder;</strong></p><p>22. <strong>import org.ethereum.crypto.HashUtil;</strong></p><p>23. <strong>import org.ethereum.datasource.Source;</strong></p><p>24. <strong>import org.ethereum.datasource.inmem.HashMapDB;</strong></p><p>25. <strong>import org.ethereum.datasource.inmem.HashMapDBSimple;</strong></p><p>26. <strong>import org.ethereum.net.swarm.Key;</strong></p><p>27. <strong>import org.ethereum.util.FastByteComparisons;</strong></p><p>28. <strong>import org.ethereum.util.RLP;</strong></p><p>29. <strong>import org.ethereum.util.Value;</strong></p><p>30. <strong>import org.slf4j.Logger;</strong></p><p>31. <strong>import org.slf4j.LoggerFactory;</strong></p><p>32. <strong>import org.spongycastle.util.encoders.Hex;</strong></p><p>33. <strong></strong> </p><p>34. <strong>import java.util.ArrayList;</strong></p><p>35. <strong>import java.util.List;</strong></p><p>36. <strong>import java.util.concurrent.*;</strong></p><p>37. <strong></strong> </p><p>38. <strong>import static org.apache.commons.lang3.concurrent.ConcurrentUtils.constantFuture;</strong></p><p>39. <strong>import static org.ethereum.crypto.HashUtil.EMPTY_TRIE_HASH;</strong></p><p>40. <strong>import static org.ethereum.util.ByteUtil.EMPTY_BYTE_ARRAY;</strong></p><p>41. <strong>import static org.ethereum.util.RLP.EMPTY_ELEMENT_RLP;</strong></p><p>42. <strong>import static org.ethereum.util.RLP.encodeElement;</strong></p><p>43. <strong>import static org.ethereum.util.RLP.encodeList;</strong></p><p>44. <strong>import static org.ethereum.util.ByteUtil.toHexString;</strong></p><p>45. <strong></strong> </p><p>46. <strong>/**</strong></p><p>47. <strong>* Created by Anton Nashatyrev on 07.02.2017.</strong></p><p>48. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsFcnOvR.png" alt=""> <strong>*/</strong></p><p>49. <strong>public class TrieImpl implements Trie&#x3C;byte[]> {</strong></p><p>50. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsEwwifH.png" alt="">    <strong>private final static Object NULL_NODE = new Object();</strong></p><p>51. <strong>private final static int MIN_BRANCHES_CONCURRENTLY = 3;</strong></p><p>52. <strong>private static ExecutorService executor;</strong></p><p>53. <strong></strong> </p><p>54. <strong>private static final Logger logger = LoggerFactory.getLogger("state");</strong></p><p>55. <strong></strong> </p><p>56. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsSzoUHj.png" alt="">    <strong>public static ExecutorService getExecutor() {</strong></p><p>57. <strong>if (executor == null) {</strong></p><p>58. <strong>executor = Executors.newFixedThreadPool(4,</strong></p><p>59. <strong>new ThreadFactoryBuilder().setNameFormat("trie-calc-thread-%d").build());</strong></p><p>60. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps7DDe2e.png" alt="">        <strong>}</strong></p><p>61. <strong>return executor;</strong></p><p>62. <strong>}</strong></p><p>63. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsI5oY4A.png" alt=""> <strong></strong> </p><p>64. <strong>public enum NodeType {</strong></p><p>65. <strong>BranchNode,</strong></p><p>66. <strong>KVNodeValue,</strong></p><p>67. <strong>KVNodeNode</strong></p><p>68. <strong>}</strong></p><p>69. <strong></strong> </p><p><img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsiPntuq.png" alt=""> </p><p>第70-429行代码是TrieImpl.Node类，解读内容详见下文。</p><p> </p><p>430. </p><p>431. <strong>public interface ScanAction {</strong></p><p>432. </p><p>70. <strong>void doOnNode(byte[] hash, Node node);</strong></p><p>71. <strong></strong> </p><p>72. <strong>void doOnValue(byte[] nodeHash, Node node, byte[] key, byte[] value);</strong></p><p>73. <strong>}</strong></p><p>74. <strong></strong> </p><p>75. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsPgvyef.png" alt="">    <strong>private Source&#x3C;byte[], byte[]> cache;</strong></p><p>76. <strong>private Node root;</strong></p><p>77. <strong>private boolean async = true;</strong></p><p>78. <strong></strong> </p><p>79. <strong>public TrieImpl() {</strong></p><p>80. <strong>this((byte[]) null);</strong></p><p>81. <strong>}</strong></p><p>82. <strong></strong> </p><p>83. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsKq0R1G.png" alt="">    <strong>public TrieImpl(byte[] root) {</strong></p><p>84. <strong>this(new HashMapDB&#x3C;byte[]>(), root);</strong></p><p>85. <strong>}</strong></p><p>86. <strong></strong> </p><p>87. <strong>public TrieImpl(Source&#x3C;byte[], byte[]> cache) {</strong></p><p>88. <strong>this(cache, null);</strong></p><p>89. <strong>}</strong></p><p>90. <strong>public TrieImpl(Source&#x3C;byte[], byte[]> cache, byte[] root) {</strong></p><p>91. <strong>this.cache = cache;</strong></p><p>92. <strong>setRoot(root);</strong></p><p>93. <strong>}</strong></p><p>94. <strong></strong> </p><p>95. <strong>public void setAsync(boolean async) {</strong></p><p>96. <strong>this.async = async;</strong></p><p>97. <strong>}</strong></p><p>98. <strong></strong> </p><p>99. <strong>private void encode() {</strong></p><p>100. <strong>if (root != null) {</strong></p><p>101. <strong>root.encode();</strong></p><p>102. <strong>}</strong></p><p>103. <strong>}</strong></p><p>104. <strong></strong> </p><p>105. <strong>public void setRoot(byte[] root) {</strong></p><p>106. <strong>if (root != null &#x26;&#x26; !FastByteComparisons.equal(root, EMPTY_TRIE_HASH)) {</strong></p><p>107. <strong>this.root = new Node(root);</strong></p><p>108. <strong>} else {</strong></p><p>109. <strong>this.root = null;</strong></p><p>110. <strong>}</strong></p><p>111. <strong></strong> </p><p>112. <strong>}</strong></p><p>113. <strong></strong> </p><p>114. <strong>private boolean hasRoot() {</strong></p><p>115. <strong>return root != null &#x26;&#x26; root.resolveCheck();</strong></p><p>116. <strong>}</strong></p><p>117. <strong></strong> </p><p>118. <strong>public Source&#x3C;byte[], byte[]> getCache() {</strong></p><p>119. <strong>return cache;</strong></p><p>120. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsd2m45z.png" alt="">    <strong>}</strong></p><p>121. <strong></strong> </p><p>122. <strong>private byte[] getHash(byte[] hash) {</strong></p><p>123. <strong>return cache.get(hash);</strong></p><p>124. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsftXfza.png" alt="">    <strong>}</strong></p><p>125. <strong>private void addHash(byte[] hash, byte[] ret) {</strong></p><p>126. <strong>cache.put(hash, ret);</strong></p><p>127. <strong>}</strong></p><p>128. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpskTwB5i.png" alt="">    <strong>private void deleteHash(byte[] hash) {</strong></p><p>129. <strong>cache.delete(hash);</strong></p><p>130. <strong>}</strong></p><p>131. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsNUS7U5.png" alt=""> <strong></strong> </p><p>132. <strong></strong> </p><p>133. <strong>public byte[] get(byte[] key) {</strong></p><p>134. <strong>if (!hasRoot()) return null; // treating unknown root hash as empty trie</strong></p><p>135. <strong>TrieKey k = TrieKey.fromNormal(key);</strong></p><p>136. <strong>return get(root, k);</strong></p><p>137. <strong>}</strong></p><p>138. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps4XLG2d.png" alt=""> <strong></strong> </p><p>139. <strong>private byte[] get(Node n, TrieKey k) {</strong></p><p>140. <strong>if (n == null) return null;</strong></p><p>141. <strong></strong> </p><p>142. <strong>NodeType type = n.getType();</strong></p><p>143. <strong>if (type == NodeType.BranchNode) {</strong></p><p>144. <strong>if (k.isEmpty()) return n.branchNodeGetValue();</strong></p><p>145. <strong>Node childNode = n.branchNodeGetChild(k.getHex(0));</strong></p><p>146. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsm6OVEN.png" alt="">            <strong>return get(childNode, k.shift(1));</strong></p><p>147. <strong>} else {</strong></p><p>148. <strong>TrieKey k1 = k.matchAndShift(n.kvNodeGetKey());</strong></p><p>149. <strong>if (k1 == null) return null;</strong></p><p>150. <strong>if (type == NodeType.KVNodeValue) {</strong></p><p>151. <strong>return k1.isEmpty() ? n.kvNodeGetValue() : null;</strong></p><p>152. <strong>} else {</strong></p><p>153. <strong>return get(n.kvNodeGetChildNode(), k1);</strong></p><p>154. <strong>}</strong></p><p>155. <strong>}</strong></p><p>156. <strong>}</strong></p><p>157. <strong></strong> </p><p>158. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsZNQRTD.png" alt="">    <strong>public void put(byte[] key, byte[] value) {</strong></p><p>159. <strong>TrieKey k = TrieKey.fromNormal(key);</strong></p><p>160. <strong>if (root == null) {</strong></p><p>161. <strong>if (value != null &#x26;&#x26; value.length > 0) {</strong></p><p>162. <strong>root = new Node(k, value);</strong></p><p>163. <strong>}</strong></p><p>164. <strong>} else {</strong></p><p>165. <strong>if (value == null || value.length == 0) {</strong></p><p>166. <strong>root = delete(root, k);</strong></p><p>167. <strong>} else {</strong></p><p>168. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsF8AgXO.png" alt="">                <strong>root = insert(root, k, value);</strong></p><p>169. <strong>}</strong></p><p>170. <strong>}</strong></p><p>171. <strong>}</strong></p><p>172. <strong></strong> </p><p>173. <strong>private Node insert(Node n, TrieKey k, Object nodeOrValue) {</strong></p><p>174. <strong>NodeType type = n.getType();</strong></p><p>175. <strong>if (type == NodeType.BranchNode) {</strong></p><p>176. <strong>if (k.isEmpty()) return n.branchNodeSetValue((byte[]) nodeOrValue);</strong></p><p>177. <strong>Node childNode = n.branchNodeGetChild(k.getHex(0));</strong></p><p>178. <strong>if (childNode != null) {</strong></p><p>179. <strong>return n.branchNodeSetChild(k.getHex(0), insert(childNode, k.shift(1), nodeOrValue));</strong></p><p>180. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsSd9IV9.png" alt="">            <strong>} else {</strong></p><p>181. <strong>TrieKey childKey = k.shift(1);</strong></p><p>182. <strong>Node newChildNode;</strong></p><p>183. <strong>if (!childKey.isEmpty()) {</strong></p><p>184. <strong>newChildNode = new Node(childKey, nodeOrValue);</strong></p><p>185. <strong>} else {</strong></p><p>186. <strong>newChildNode = nodeOrValue instanceof Node ?</strong></p><p>187. <strong>(Node) nodeOrValue : new Node(childKey, nodeOrValue);</strong></p><p>188. <strong>}</strong></p><p>189. <strong>return n.branchNodeSetChild(k.getHex(0), newChildNode);</strong></p><p>190. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsPjqDWf.png" alt="">            <strong>}</strong></p><p>191. <strong>} else {</strong></p><p>192. <strong>TrieKey commonPrefix = k.getCommonPrefix(n.kvNodeGetKey());</strong></p><p>193. <strong>if (commonPrefix.isEmpty()) {</strong></p><p>194. <strong>Node newBranchNode = new Node();</strong></p><p>195. <strong>insert(newBranchNode, n.kvNodeGetKey(), n.kvNodeGetValueOrNode());</strong></p><p>196. <strong>insert(newBranchNode, k, nodeOrValue);</strong></p><p>197. <strong>n.dispose();</strong></p><p>198. <strong>return newBranchNode;</strong></p><p>199. <strong>} else if (commonPrefix.equals(k)) {</strong></p><p>200. <strong>return n.kvNodeSetValueOrNode(nodeOrValue);</strong></p><p>201. <strong>} else if (commonPrefix.equals(n.kvNodeGetKey())) {</strong></p><p>202. <strong>insert(n.kvNodeGetChildNode(), k.shift(commonPrefix.getLength()), nodeOrValue);</strong></p><p>203. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsyyxtah.png" alt="">                <strong>return n.invalidate();</strong></p><p>204. <strong>} else {</strong></p><p>205. <strong>Node newBranchNode = new Node();</strong></p><p>206. <strong>Node newKvNode = new Node(commonPrefix, newBranchNode);</strong></p><p>207. <strong>// TODO can be optimized</strong></p><p>208. <strong>insert(newKvNode, n.kvNodeGetKey(), n.kvNodeGetValueOrNode());</strong></p><p>209. <strong>insert(newKvNode, k, nodeOrValue);</strong></p><p>210. <strong>n.dispose();</strong></p><p>211. <strong>return newKvNode;</strong></p><p>212. <strong>}</strong></p><p>213. <strong>}</strong></p><p>214. <strong>}</strong></p><p>215. <strong></strong> </p><p>216. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsQivlpI.png" alt="">    <strong>@Override</strong></p><p>217. <strong>public void delete(byte[] key) {</strong></p><p>218. <strong>TrieKey k = TrieKey.fromNormal(key);</strong></p><p>219. <strong>if (root != null) {</strong></p><p>220. <strong>root = delete(root, k);</strong></p><p>221. <strong>}</strong></p><p>222. <strong>}</strong></p><p>223. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsOOdmoA.png" alt=""> <strong></strong> </p><p>224. <strong>private Node delete(Node n, TrieKey k) {</strong></p><p>225. <strong>NodeType type = n.getType();</strong></p><p>226. <strong>Node newKvNode;</strong></p><p>227. <strong>if (type == NodeType.BranchNode) {</strong></p><p>228. <strong>if (k.isEmpty())  {</strong></p><p>229. <strong>n.branchNodeSetValue(null);</strong></p><p>230. <strong>} else {</strong></p><p>231. <strong>int idx = k.getHex(0);</strong></p><p>232. <strong>Node child = n.branchNodeGetChild(idx);</strong></p><p>233. <strong>if (child == null) return n; // no key found</strong></p><p>234. <strong></strong> </p><p>235. <strong>Node newNode = delete(child, k.shift(1));</strong></p><p>236. <strong>n.branchNodeSetChild(idx, newNode);</strong></p><p>237. <strong>if (newNode != null) return n; // newNode != null thus number of children didn't decrease</strong></p><p>238. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsKXOwsf.png" alt="">            <strong>}</strong></p><p>239. <strong></strong> </p><p>240. <strong>// child node or value was deleted and the branch node may need to be compacted</strong></p><p>241. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsVShGuC.png" alt="">            <strong>int compactIdx = n.branchNodeCompactIdx();</strong></p><p>242. <strong>if (compactIdx &#x3C; 0) return n; // no compaction is required</strong></p><p>243. <strong></strong> </p><p>244. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsoS09oN.png" alt="">            <strong>// only value or a single child left - compact branch node to kvNode</strong></p><p>245. <strong>n.dispose();</strong></p><p>246. <strong>if (compactIdx == 16) { // only value left</strong></p><p>247. <strong>return new Node(TrieKey.empty(true), n.branchNodeGetValue());</strong></p><p>248. <strong>} else { // only single child left</strong></p><p>249. <strong>newKvNode = new Node(TrieKey.singleHex(compactIdx), n.branchNodeGetChild(compactIdx));</strong></p><p>250. <strong>}</strong></p><p>251. <strong>} else { // n - kvNode</strong></p><p>252. <strong>TrieKey k1 = k.matchAndShift(n.kvNodeGetKey());</strong></p><p>253. <strong>if (k1 == null) {</strong></p><p>254. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsGjPEy6.png" alt="">                <strong>// no key found</strong></p><p>255. <strong>return n;</strong></p><p>256. <strong>} else if (type == NodeType.KVNodeValue) {</strong></p><p>257. <strong>if (k1.isEmpty()) {</strong></p><p>258. <strong>// delete this kvNode</strong></p><p>259. <strong>n.dispose();</strong></p><p>260. <strong>return null;</strong></p><p>261. <strong>} else {</strong></p><p>262. <strong>// else no key found</strong></p><p>263. <strong>return n;</strong></p><p>264. <strong>}</strong></p><p>265. <strong>} else {</strong></p><p>266. <strong>Node newChild = delete(n.kvNodeGetChildNode(), k1);</strong></p><p>267. <strong>if (newChild == null) throw new RuntimeException("Shouldn't happen");</strong></p><p>268. <strong>newKvNode = n.kvNodeSetValueOrNode(newChild);</strong></p><p>269. <strong>}</strong></p><p>270. <strong>}</strong></p><p>271. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsr1EAo2.png" alt=""> <strong></strong> </p><p>272. <strong>// if we get here a new kvNode was created, now need to check</strong></p><p>273. <strong>// if it should be compacted with child kvNode</strong></p><p>274. <strong>Node newChild = newKvNode.kvNodeGetChildNode();</strong></p><p>275. <strong>if (newChild.getType() != NodeType.BranchNode) {</strong></p><p>276. <strong>// two kvNodes should be compacted into a single one</strong></p><p>277. <strong>TrieKey newKey = newKvNode.kvNodeGetKey().concat(newChild.kvNodeGetKey());</strong></p><p>278. <strong>Node newNode = new Node(newKey, newChild.kvNodeGetValueOrNode());</strong></p><p>279. <strong>newChild.dispose();</strong></p><p>280. <strong>newKvNode.dispose();</strong></p><p>281. <strong>return newNode;</strong></p><p>282. <strong>} else {</strong></p><p>283. <strong>// no compaction needed</strong></p><p>284. <strong>return newKvNode;</strong></p><p>285. <strong>}</strong></p><p>286. <strong>}</strong></p><p>287. <strong></strong> </p><p>288. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsYooVIY.png" alt="">    <strong>@Override</strong></p><p>289. <strong>public byte[] getRootHash() {</strong></p><p>290. <strong>encode();</strong></p><p>291. <strong>return root != null ? root.hash : EMPTY_TRIE_HASH;</strong></p><p>292. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpszFIbhz.png" alt="">    <strong>}</strong></p><p>293. <strong></strong> </p><p>294. <strong>@Override</strong></p><p>295. <strong>public void clear() {</strong></p><p>296. <strong>throw new RuntimeException("Not implemented yet");</strong></p><p>297. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsqCQFzA.png" alt="">    <strong>}</strong></p><p>298. <strong></strong> </p><p>299. <strong>@Override</strong></p><p>300. <strong>public boolean flush() {</strong></p><p>301. <strong>if (root != null &#x26;&#x26; root.dirty) {</strong></p><p>302. <strong>// persist all dirty nodes to underlying Source</strong></p><p>303. <strong>encode();</strong></p><p>304. <strong>// release all Trie Node instances for GC</strong></p><p>305. <strong>root = new Node(root.hash);</strong></p><p>306. <strong>return true;</strong></p><p>307. <strong>} else {</strong></p><p>308. <strong>return false;</strong></p><p>309. <strong>}</strong></p><p>310. <strong>}</strong></p><p>311. <strong></strong> </p><p>312. <strong>@Override</strong></p><p>313. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsdNQ88A.png" alt="">    <strong>public boolean equals(Object o) {</strong></p><p>314. <strong>if (this == o) return true;</strong></p><p>315. <strong>if (o == null || getClass() != o.getClass()) return false;</strong></p><p>316. <strong></strong> </p><p>317. <strong>TrieImpl trieImpl1 = (TrieImpl) o;</strong></p><p>318. <strong></strong> </p><p>319. <strong>return FastByteComparisons.equal(getRootHash(), trieImpl1.getRootHash());</strong></p><p>320. <strong></strong> </p><p>321. <strong>}</strong></p><p>322. <strong></strong> </p><p>323. <strong>public String dumpStructure() {</strong></p><p>324. <strong>return root == null ? "&#x3C;empty>" : root.dumpStruct("", "");</strong></p><p>325. <strong>}</strong></p><p>326. <strong>public String dumpTrie() {</strong></p><p>327. <strong>return dumpTrie(true);</strong></p><p>328. <strong>}</strong></p><p>329. <strong>public String dumpTrie(boolean compact) {</strong></p><p>330. <strong>if (root == null) return "&#x3C;empty>";</strong></p><p>331. <strong>encode();</strong></p><p>332. <strong>StrBuilder ret = new StrBuilder();</strong></p><p>333. <strong>List&#x3C;String> strings = root.dumpTrieNode(compact);</strong></p><p>334. <strong>ret.append("Root: " + hash2str(getRootHash(), compact) + "\n");</strong></p><p>335. <strong>for (String s : strings) {</strong></p><p>336. <strong>ret.append(s).append('\n');</strong></p><p>337. <strong>}</strong></p><p>338. <strong>return ret.toString();</strong></p><p>339. <strong>}</strong></p><p>340. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsmqnDU7.png" alt=""> <strong></strong> </p><p>341. <strong>public void scanTree(ScanAction scanAction) {</strong></p><p>342. <strong>scanTree(root, TrieKey.empty(false), scanAction);</strong></p><p>343. <strong>}</strong></p><p>344. <strong></strong> </p><p>345. <strong>public void scanTree(Node node, TrieKey k, ScanAction scanAction) {</strong></p><p>346. <strong>if (node == null) return;</strong></p><p>347. <strong>if (node.hash != null) {</strong></p><p>348. <strong>scanAction.doOnNode(node.hash, node);</strong></p><p>349. <strong>}</strong></p><p>350. <strong>if (node.getType() == NodeType.BranchNode) {</strong></p><p>351. <strong>if (node.branchNodeGetValue() != null)</strong></p><p>352. <strong>scanAction.doOnValue(node.hash, node, k.toNormal(), node.branchNodeGetValue());</strong></p><p>353. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>354. <strong>scanTree(node.branchNodeGetChild(i), k.concat(TrieKey.singleHex(i)), scanAction);</strong></p><p>355. <strong>}</strong></p><p>356. <strong>} else if (node.getType() == NodeType.KVNodeNode) {</strong></p><p>357. <strong>scanTree(node.kvNodeGetChildNode(), k.concat(node.kvNodeGetKey()), scanAction);</strong></p><p>358. <strong>} else {</strong></p><p>359. <strong>scanAction.doOnValue(node.hash, node, k.concat(node.kvNodeGetKey()).toNormal(), node.kvNodeGetValue());</strong></p><p>360. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsaPP2lc.png" alt="">        <strong>}</strong></p><p>361. <strong>}</strong></p><p>362. <strong></strong> </p><p>363. <strong></strong> </p><p>364. <strong>private static String hash2str(byte[] hash, boolean shortHash) {</strong></p><p>365. <strong>String ret = Hex.toHexString(hash);</strong></p><p>366. <strong>return "0x" + (shortHash ? ret.substring(0,8) : ret);</strong></p><p>367. <strong>}</strong></p><p>368. <strong></strong> </p><p>369. <strong>private static String val2str(byte[] val, boolean shortHash) {</strong></p><p>370. <strong>String ret = Hex.toHexString(val);</strong></p><p>371. <strong>if (val.length > 16) {</strong></p><p>372. <strong>ret = ret.substring(0,10) + "... len " + val.length;</strong></p><p>373. <strong>}</strong></p><p>374. <strong>return "\"" + ret + "\"";</strong></p><p>375. <strong>}</strong></p><p>376. <strong>}</strong></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

&#x20;

² 补充说明1：

此函数采用了“懒加载”方式，在类加载时没有对属性赋值，而是在程序运行时根据需要对此属性赋值。

在语法上来讲，类似于设计模式中的单例模式(Singleton)的懒汉方式，需要注意的是单例模式的使用场景是控制类的实例全局唯一，而此函数的场景是控制executor静态属性的初始化时间点，所以这里只是想“懒加载”，而没有“单例”的诉求。

之所以，引出单例模式的懒汉方式的概念，是每一种设计模式都有适用场景和常见问题，而getExecutor函数借鉴了懒汉方式的思路，同时也存在一个此方式的问题：懒汉模式是非线程安全的，可以通过给函数或代码段加锁的方式解决。

\


**TrieImpl.Node内部类源代码解读**

| <p>70. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps96FnkR.png" alt="">    <strong>public final class Node {</strong></p><p>377. <strong>private byte[] hash = null;</strong> </p><p>378. <strong>private byte[] rlp = null;</strong></p><p>379. <strong>private RLP.LList parsedRlp = null;</strong></p><p>380. <strong>private boolean dirty = false;</strong></p><p>381. <strong></strong> </p><p>382. <strong>private Object[] children = null;</strong></p><p>383. <strong></strong> </p><p>384. <strong>// new empty BranchNode</strong></p><p>385. <strong>public Node() {</strong></p><p>386. <strong>children = new Object[17];</strong></p><p>387. <strong>dirty = true;</strong></p><p>388. <strong>}</strong></p><p>389. <strong></strong> </p><p>390. <strong>// new KVNode with key and (value or node)</strong></p><p>391. <strong>public Node(TrieKey key, Object valueOrNode) {</strong></p><p>392. <strong>this(new Object[]{key, valueOrNode});</strong></p><p>393. <strong>dirty = true;</strong></p><p>394. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpstozx9F.png" alt="">        <strong>}</strong></p><p>395. <strong></strong> </p><p>396. <strong>// new Node with hash or RLP</strong></p><p>397. <strong>public Node(byte[] hashOrRlp) {</strong></p><p>398. <strong>if (hashOrRlp.length == 32) {</strong></p><p>399. <strong>this.hash = hashOrRlp;</strong></p><p>400. <strong>} else {</strong></p><p>401. <strong>this.rlp = hashOrRlp;</strong></p><p>402. <strong>}</strong></p><p>403. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsqsmPP6.png" alt="">        <strong>}</strong></p><p>404. <strong></strong> </p><p>405. <strong>private Node(RLP.LList parsedRlp) {</strong></p><p>406. <strong>this.parsedRlp = parsedRlp;</strong></p><p>407. <strong>this.rlp = parsedRlp.getEncoded();</strong></p><p>408. <strong>}</strong></p><p>409. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsBOb2mL.png" alt=""> <strong></strong> </p><p>410. <strong>private Node(Object[] children) {</strong></p><p>411. <strong>this.children = children;</strong></p><p>412. <strong>}</strong></p><p>413. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsOIZ9BI.png" alt=""> <strong></strong> </p><p>414. <strong>public boolean resolveCheck() {</strong></p><p>415. <strong>if (rlp != null || parsedRlp != null || hash == null) return true;</strong></p><p>416. <strong>rlp = getHash(hash);</strong></p><p>417. <strong>return rlp != null;</strong></p><p>418. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsnP8vcd.png" alt="">        <strong>}</strong></p><p>419. <strong></strong> </p><p>420. <strong>private void resolve() {</strong></p><p>421. <strong>if (!resolveCheck()) {</strong></p><p>422. <strong>logger.error("Invalid Trie state, can't resolve hash " + toHexString(hash));</strong></p><p>423. <strong>throw new RuntimeException("Invalid Trie state, can't resolve hash " + toHexString(hash));</strong></p><p>424. <strong>}</strong></p><p>425. <strong>}</strong></p><p>426. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpstYmYT9.png" alt=""> <strong></strong> </p><p>427. <strong>public byte[] encode() {</strong></p><p>428. <strong>return encode(1, true);</strong></p><p>429. <strong>}</strong></p><p>430. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsrTWK5K.png" alt="">        <strong>private byte[] encode(final int depth, boolean forceHash) {</strong></p><p>431. <strong>if (!dirty) {</strong></p><p>432. <strong>return hash != null ? encodeElement(hash) : rlp;</strong></p><p>433. <strong>} else {</strong></p><p>434. <strong>NodeType type = getType();</strong></p><p>435. <strong>byte[] ret;</strong></p><p>436. <strong>if (type == NodeType.BranchNode) {</strong></p><p>437. <strong>if (depth == 1 &#x26;&#x26; async) {</strong></p><p>438. <strong>// parallelize encode() on the first trie level only and if there are at least</strong></p><p>439. <strong>// MIN_BRANCHES_CONCURRENTLY branches are modified</strong></p><p>440. <strong>final Object[] encoded = new Object[17];</strong></p><p>441. <strong>int encodeCnt = 0;</strong></p><p>442. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>443. <strong>final Node child = branchNodeGetChild(i);</strong></p><p>444. <strong>if (child == null) {</strong></p><p>445. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps9jifs1.png" alt="">                                <strong>encoded[i] = EMPTY_ELEMENT_RLP;</strong></p><p>446. <strong>} else if (!child.dirty) {</strong></p><p>447. <strong>encoded[i] = child.encode(depth + 1, false);</strong></p><p>448. <strong>} else {</strong></p><p>449. <strong>encodeCnt++;</strong></p><p>450. <strong>}</strong></p><p>451. <strong>}</strong></p><p>452. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>453. <strong>if (encoded[i] == null) {</strong></p><p>454. <strong>final Node child = branchNodeGetChild(i);</strong></p><p>455. <strong>if (encodeCnt >= MIN_BRANCHES_CONCURRENTLY) {</strong></p><p>456. <strong>encoded[i] = getExecutor().submit(() -> child.encode(depth + 1, false));</strong></p><p>457. <strong>} else {</strong></p><p>458. <strong>encoded[i] = child.encode(depth + 1, false);</strong></p><p>459. <strong>}</strong></p><p>460. <strong>}</strong></p><p>461. <strong>}</strong></p><p>462. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsfzfwZH.png" alt="">                        <strong>byte[] value = branchNodeGetValue();</strong></p><p>463. <strong>encoded[16] = constantFuture(encodeElement(value));</strong></p><p>464. <strong>try {</strong></p><p>465. <strong>ret = encodeRlpListFutures(encoded);</strong></p><p>466. <strong>} catch (Exception e) {</strong></p><p>467. <strong>throw new RuntimeException(e);</strong></p><p>468. <strong>}</strong></p><p>469. <strong>} else {</strong></p><p>470. <strong>byte[][] encoded = new byte[17][];</strong></p><p>471. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>472. <strong>Node child = branchNodeGetChild(i);</strong></p><p>473. <strong>encoded[i] = child == null ? EMPTY_ELEMENT_RLP : child.encode(depth + 1, false);</strong></p><p>474. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsta0Khw.png" alt="">                        <strong>}</strong></p><p>475. <strong>byte[] value = branchNodeGetValue();</strong></p><p>476. <strong>encoded[16] = encodeElement(value);</strong></p><p>477. <strong>ret = encodeList(encoded);</strong></p><p>478. <strong>}</strong></p><p>479. <strong>} else if (type == NodeType.KVNodeNode) {</strong></p><p>480. <strong>ret = encodeList(encodeElement(kvNodeGetKey().toPacked()), kvNodeGetChildNode().encode(depth + 1, false));</strong></p><p>481. <strong>} else {</strong></p><p>482. <strong>byte[] value = kvNodeGetValue();</strong></p><p>483. <strong>ret = encodeList(encodeElement(kvNodeGetKey().toPacked()),</strong></p><p>484. <strong>encodeElement(value == null ? EMPTY_BYTE_ARRAY : value));</strong></p><p>485. <strong>}</strong></p><p>486. <strong>if (hash != null) {</strong></p><p>487. <strong>deleteHash(hash);</strong></p><p>488. <strong>}</strong></p><p>489. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpstdQca6.png" alt="">                <strong>dirty = false;</strong></p><p>490. <strong>if (ret.length &#x3C; 32 &#x26;&#x26; !forceHash) {</strong></p><p>491. <strong>rlp = ret;</strong></p><p>492. <strong>return ret;</strong></p><p>493. <strong>} else {</strong></p><p>494. <strong>hash = HashUtil.sha3(ret);</strong></p><p>495. <strong>addHash(hash, ret);</strong></p><p>496. <strong>return encodeElement(hash);</strong></p><p>497. <strong>}</strong></p><p>498. <strong>}</strong></p><p>499. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsxLftAK.png" alt="">        <strong>}</strong></p><p>500. <strong></strong> </p><p>501. <strong>@SafeVarargs</strong></p><p>502. <strong>private final byte[] encodeRlpListFutures(Object... list) throws ExecutionException, InterruptedException {</strong></p><p>503. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsmiZczJ.png" alt="">            <strong>byte[][] vals = new byte[list.length][];</strong></p><p>504. <strong>for (int i = 0; i &#x3C; list.length; i++) {</strong></p><p>505. <strong>if (list[i] instanceof Future) {</strong></p><p>506. <strong>vals[i] = ((Future&#x3C;byte[]>) list[i]).get();</strong></p><p>507. <strong>} else {</strong></p><p>508. <strong>vals[i] = (byte[]) list[i];</strong></p><p>509. <strong>}</strong></p><p>510. <strong>}</strong></p><p>511. <strong>return encodeList(vals);</strong></p><p>512. <strong>}</strong></p><p>513. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsq3JY2p.png" alt=""> <strong></strong> </p><p>514. <strong>private void parse() {</strong></p><p>515. <strong>if (children != null) return;</strong></p><p>516. <strong>resolve();</strong></p><p>517. <strong></strong> </p><p>518. <strong>RLP.LList list = parsedRlp == null ? RLP.decodeLazyList(rlp) : parsedRlp;</strong></p><p>519. <strong></strong> </p><p>520. <strong>if (list.size() == 2) {</strong></p><p>521. <strong>children = new Object[2];</strong></p><p>522. <strong>TrieKey key = TrieKey.fromPacked(list.getBytes(0));</strong></p><p>523. <strong>children[0] = key;</strong></p><p>524. <strong>if (key.isTerminal()) {</strong></p><p>525. <strong>children[1] = list.getBytes(1);</strong></p><p>526. <strong>} else {</strong></p><p>527. <strong>children[1] = list.isList(1) ? new Node(list.getList(1)) : new Node(list.getBytes(1));</strong></p><p>528. <strong>}</strong></p><p>529. <strong>} else {</strong></p><p>530. <strong>children = new Object[17];</strong></p><p>531. <strong>parsedRlp = list;</strong></p><p>532. <strong>}</strong></p><p>533. <strong>}</strong></p><p>534. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsYbdjWR.png" alt=""> <strong></strong> </p><p>535. <strong>public Node branchNodeGetChild(int hex) {</strong></p><p>536. <strong>parse();</strong></p><p>537. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>538. <strong>Object n = children[hex];</strong></p><p>539. <strong>if (n == null &#x26;&#x26; parsedRlp != null) {</strong></p><p>540. <strong>if (parsedRlp.isList(hex)) {</strong></p><p>541. <strong>n = new Node(parsedRlp.getList(hex));</strong></p><p>542. <strong>} else {</strong></p><p>543. <strong>byte[] bytes = parsedRlp.getBytes(hex);</strong></p><p>544. <strong>if (bytes.length == 0) {</strong></p><p>545. <strong>n = NULL_NODE;</strong></p><p>546. <strong>} else {</strong></p><p>547. <strong>n = new Node(bytes);</strong></p><p>548. <strong>}</strong></p><p>549. <strong>}</strong></p><p>550. <strong>children[hex] = n;</strong></p><p>551. <strong>}</strong></p><p>552. <strong>return n == NULL_NODE ? null : (Node) n;</strong></p><p>553. <strong>}</strong></p><p>554. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsZznRVN.png" alt=""> <strong></strong> </p><p>555. <strong>public Node branchNodeSetChild(int hex, Node node) {</strong></p><p>556. <strong>parse();</strong></p><p>557. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>558. <strong>children[hex] = node == null ? NULL_NODE : node;</strong></p><p>559. <strong>dirty = true;</strong></p><p>560. <strong>return this;</strong></p><p>561. <strong>}</strong></p><p>562. <strong></strong> </p><p>563. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpso6s8Bi.png" alt="">        <strong>public byte[] branchNodeGetValue() {</strong></p><p>564. <strong>parse();</strong></p><p>565. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>566. <strong>Object n = children[16];</strong></p><p>567. <strong>if (n == null &#x26;&#x26; parsedRlp != null) {</strong></p><p>568. <strong>byte[] bytes = parsedRlp.getBytes(16);</strong></p><p>569. <strong>if (bytes.length == 0) {</strong></p><p>570. <strong>n = NULL_NODE;</strong></p><p>571. <strong>} else {</strong></p><p>572. <strong>n = bytes;</strong></p><p>573. <strong>}</strong></p><p>574. <strong>children[16] = n;</strong></p><p>575. <strong>}</strong></p><p>576. <strong>return n == NULL_NODE ? null : (byte[]) n;</strong></p><p>577. <strong>}</strong></p><p>578. <strong></strong> </p><p>579. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsjNfiv4.png" alt="">        <strong>public Node branchNodeSetValue(byte[] val) {</strong></p><p>580. <strong>parse();</strong></p><p>581. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>582. <strong>children[16] = val == null ? NULL_NODE : val;</strong></p><p>583. <strong>dirty = true;</strong></p><p>584. <strong>return this;</strong></p><p>585. <strong>}</strong></p><p>586. <strong></strong> </p><p>587. <strong>public int branchNodeCompactIdx() {</strong></p><p>588. <strong>parse();</strong></p><p>589. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>590. <strong>int cnt = 0;</strong></p><p>591. <strong>int idx = -1;</strong></p><p>592. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>593. <strong>if (branchNodeGetChild(i) != null) {</strong></p><p>594. <strong>cnt++;</strong></p><p>595. <strong>idx = i;</strong></p><p>596. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsMqn71I.png" alt="">                    <strong>if (cnt > 1) return -1;</strong></p><p>597. <strong>}</strong></p><p>598. <strong>}</strong></p><p>599. <strong>return cnt > 0 ? idx : (branchNodeGetValue() == null ? -1 : 16);</strong></p><p>600. <strong>}</strong></p><p>601. <strong>public boolean branchNodeCanCompact() {</strong></p><p>602. <strong>parse();</strong></p><p>603. <strong>assert getType() == NodeType.BranchNode;</strong></p><p>604. <strong>int cnt = 0;</strong></p><p>605. <strong>for (int i = 0; i &#x3C; 16; i++) {</strong></p><p>606. <strong>cnt += branchNodeGetChild(i) == null ? 0 : 1;</strong></p><p>607. <strong>if (cnt > 1) return false;</strong></p><p>608. <strong>}</strong></p><p>609. <strong>return cnt == 0 || branchNodeGetValue() == null;</strong></p><p>610. <strong>}</strong></p><p>611. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps6GZvhv.png" alt=""> <strong></strong> </p><p>612. <strong>public TrieKey kvNodeGetKey() {</strong></p><p>613. <strong>parse();</strong></p><p>614. <strong>assert getType() != NodeType.BranchNode;</strong></p><p>615. <strong>return (TrieKey) children[0];</strong></p><p>616. <strong>}</strong></p><p>617. <strong></strong> </p><p>618. <strong>public Node kvNodeGetChildNode() {</strong></p><p>619. <strong>parse();</strong></p><p>620. <strong>assert getType() == NodeType.KVNodeNode;</strong></p><p>621. <strong>return (Node) children[1];</strong></p><p>622. <strong>}</strong></p><p>623. <strong></strong> </p><p>624. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsJZzO09.png" alt="">        <strong>public byte[] kvNodeGetValue() {</strong></p><p>625. <strong>parse();</strong></p><p>626. <strong>assert getType() == NodeType.KVNodeValue;</strong></p><p>627. <strong>return (byte[]) children[1];</strong></p><p>628. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsDuP3hg.png" alt="">        <strong>}</strong></p><p>629. <strong>public Node kvNodeSetValue(byte[] value) {</strong></p><p>630. <strong>parse();</strong></p><p>631. <strong>assert getType() == NodeType.KVNodeValue;</strong></p><p>632. <strong>children[1] = value;</strong></p><p>633. <strong>dirty = true;</strong></p><p>634. <strong>return this;</strong></p><p>635. <strong>}</strong></p><p>636. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsto95ZF.png" alt=""> <strong></strong> </p><p>637. <strong>public Object kvNodeGetValueOrNode() {</strong></p><p>638. <strong>parse();</strong></p><p>639. <strong>assert getType() != NodeType.BranchNode;</strong></p><p>640. <strong>return children[1];</strong></p><p>641. <strong>}</strong></p><p>642. <strong></strong> </p><p>643. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsX4f6EB.png" alt="">        <strong>public Node kvNodeSetValueOrNode(Object valueOrNode) {</strong></p><p>644. <strong>parse();</strong></p><p>645. <strong>assert getType() != NodeType.BranchNode;</strong></p><p>646. <strong>children[1] = valueOrNode;</strong></p><p>647. <strong>dirty = true;</strong></p><p>648. <strong>return this;</strong></p><p>649. <strong>}</strong></p><p>650. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps5dFp9T.png" alt=""> <strong></strong> </p><p>651. <strong>public NodeType getType() {</strong></p><p>652. <strong>parse();</strong></p><p>653. <strong></strong> </p><p>654. <strong>return children.length == 17 ? NodeType.BranchNode :</strong></p><p>655. <strong>(children[1] instanceof Node ? NodeType.KVNodeNode : NodeType.KVNodeValue);</strong></p><p>656. <strong>}</strong></p><p>657. <strong></strong> </p><p>658. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsCbY4hP.png" alt="">        <strong>public void dispose() {</strong></p><p>659. <strong>if (hash != null) {</strong></p><p>660. <strong>deleteHash(hash);</strong></p><p>661. <strong>}</strong></p><p>662. <strong>}</strong></p><p>663. <strong></strong> </p><p>664. <strong>public Node invalidate() {</strong></p><p>665. <strong>dirty = true;</strong></p><p>666. <strong>return this;</strong></p><p>667. <strong>}</strong></p><p>668. <strong></strong> </p><p> </p><p>此处省略第362-424行代码，包含用于测试类3个函数：dumpStruct、dumpTrieNode、dumpContent。</p><p> <strong></strong> </p><p>425. <strong>@Override</strong></p><p>426. <strong>public String toString() {</strong></p><p>669. <strong>return getType() + (dirty ? " *" : "") + (hash == null ? "" : "(hash: " + toHexString(hash) + " )");</strong></p><p>670. <strong>}</strong></p><p>671. <strong>}</strong></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

&#x20;

&#x20;
