# TrieKey.java解读

MPT树中的叶子节点和扩展节点都包含节点Key。在构建MPT树时，以半字节(nibble，4个bit)为单位查找多个Key的公共前缀和创建节点。为了方便对半字节的处理，及对节点类型的区分，以太坊黄皮书中设计了一种专门用于MPT树的HP（Hex-Prefix，十六进制前缀）编码，编码后的内容包含2部分：

l 前缀部分

前缀是半个字节，取值范围是0-3（含义如下表）

| <p><strong>半字节数量</strong></p><p><strong>节点类型</strong></p> | **奇数(1)**                             | **偶数(0)**                             |
| --------------------------------------------------------- | ------------------------------------- | ------------------------------------- |
| **叶子节点(2)**                                               | <p><strong>3</strong></p><p>(2+1)</p> | <p><strong>2</strong></p><p>(2+0)</p> |
| **非叶子节点(0)**                                              | <p><strong>1</strong></p><p>(0+1)</p> | <p><strong>0</strong></p><p>(0+0)</p> |

&#x20;

l 原文部分

原文包含N（整数）个半字节，HP编码对原文半字节个数的奇偶性是敏感的，对应2种不同的编码格式：

| **原文的半字节个数** | **HP编码字节数组**                                 |
| ------------ | -------------------------------------------- |
| 偶数           | \[ 前缀半字节（高位）,  (原文半字节 + 原文半字节),  ... ]       |
| 奇数           | \[ (前缀半字节 + 原文半字节),  (原文半字节 + 原文半字节),  ... ] |

&#x20;

&#x20;

\


| <p>18. <strong>package org.ethereum.trie;</strong></p><p>19. </p><p>20. <strong>import static org.ethereum.util.ByteUtil.EMPTY_BYTE_ARRAY;</strong></p><p>21. <strong>import static org.ethereum.util.ByteUtil.toHexString;</strong></p><p>22. </p><p>23. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpskimeUO.png" alt=""><strong>/**</strong></p><p>24. <strong>* Created by Anton Nashatyrev on 13.02.2017.</strong></p><p>25. <strong>*/</strong></p><p>26. <strong>public final class TrieKey {</strong></p><p>27. <strong>public static final int ODD_OFFSET_FLAG = 0x1;</strong></p><p>28. <strong>public static final int TERMINATOR_FLAG = 0x2;</strong></p><p>29. <strong>private final byte[] key;</strong></p><p>30. <strong>private final int off;</strong></p><p>31. <strong>private final boolean terminal;</strong></p><p>32. </p><p>33. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpskTcnqM.png" alt="">    <strong>public static TrieKey fromNormal(byte[] key) {</strong></p><p>34. <strong>return new TrieKey(key);</strong></p><p>35. <strong>}</strong></p><p>36. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsSJg0pt.png" alt=""></p><p>37. <strong>public static TrieKey fromPacked(byte[] key) {</strong></p><p>38. <strong>return new TrieKey(key, ((key[0] >> 4) &#x26; ODD_OFFSET_FLAG) != 0 ? 1 : 2, ((key[0] >> 4) &#x26; TERMINATOR_FLAG) != 0);</strong></p><p>39. <strong>}</strong></p><p>40. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsyy8CQE.png" alt=""></p><p>41. <strong>public static TrieKey empty(boolean terminal) {</strong></p><p>42. <strong>return new TrieKey(EMPTY_BYTE_ARRAY, 0, terminal);</strong></p><p>43. <strong>}</strong></p><p>44. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsY8GstK.png" alt=""></p><p>45. <strong>public static TrieKey singleHex(int hex) {</strong></p><p>46. <strong>TrieKey ret = new TrieKey(new byte[1], 1, false);</strong></p><p>47. <strong>ret.setHex(0, hex);</strong></p><p>48. <strong>return ret;</strong></p><p>49. <strong>}</strong></p><p>50. </p><p>51. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpswRAhr5.png" alt="">    <strong>public TrieKey(byte[] key, int off, boolean terminal) {</strong></p><p>52. <strong>this.terminal = terminal;</strong></p><p>53. <strong>this.off = off;</strong></p><p>54. <strong>this.key = key;</strong></p><p>55. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsX7vheu.png" alt="">    <strong>}</strong></p><p>56. </p><p>57. <strong>private TrieKey(byte[] key) {</strong></p><p>58. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpskV3LO3.png" alt="">        <strong>this(key, 0, true);</strong></p><p>59. <strong>}</strong></p><p>60. </p><p>61. <strong>public byte[] toPacked() {</strong></p><p>62. <strong>int flags = ((off &#x26; 1) != 0 ? ODD_OFFSET_FLAG : 0) | (terminal ? TERMINATOR_FLAG : 0);</strong></p><p>63. <strong>byte[] ret = new byte[getLength() / 2 + 1];</strong></p><p>64. <strong>int toCopy = (flags &#x26; ODD_OFFSET_FLAG) != 0 ? ret.length : ret.length - 1;</strong></p><p>65. <strong>System.arraycopy(key, key.length - toCopy, ret, ret.length - toCopy, toCopy);</strong></p><p>66. <strong>ret[0] &#x26;= 0x0F;</strong></p><p>67. <strong>ret[0] |= flags &#x3C;&#x3C; 4;</strong></p><p>68. <strong>return ret;</strong></p><p>69. <strong>}</strong></p><p>70. </p><p>71. <strong>public byte[] toNormal() {</strong></p><p>72. <strong>if ((off &#x26; 1) != 0) throw new RuntimeException("Can't convert a key with odd number of hexes to normal: " + this);</strong></p><p>73. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsTlTEsw.png" alt="">        <strong>int arrLen = key.length - off / 2;</strong></p><p>74. <strong>byte[] ret = new byte[arrLen];</strong></p><p>75. <strong>System.arraycopy(key, key.length - arrLen, ret, 0, arrLen);</strong></p><p>76. <strong>return ret;</strong></p><p>77. <strong>}</strong></p><p>78. </p><p>79. <strong>public boolean isTerminal() {</strong></p><p>80. <strong>return terminal;</strong></p><p>81. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpszcmigW.png" alt="">    <strong>}</strong></p><p>82. </p><p>83. <strong>public boolean isEmpty() {</strong></p><p>84. <strong>return getLength() == 0;</strong></p><p>85. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps9Yj06E.png" alt="">    <strong>}</strong></p><p>86. </p><p>87. <strong>public TrieKey shift(int hexCnt) {</strong></p><p>88. <strong>return new TrieKey(this.key, off + hexCnt, terminal);</strong></p><p>89. <strong>}</strong></p><p>90. </p><p>91. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsyPF4Go.png" alt="">    <strong>public TrieKey getCommonPrefix(TrieKey k) {</strong></p><p>92. <strong>// TODO can be optimized</strong></p><p>93. <strong>int prefixLen = 0;</strong></p><p>94. <strong>int thisLength = getLength();</strong></p><p>95. <strong>int kLength = k.getLength();</strong></p><p>96. <strong>while (prefixLen &#x3C; thisLength &#x26;&#x26; prefixLen &#x3C; kLength &#x26;&#x26; getHex(prefixLen) == k.getHex(prefixLen))</strong></p><p>97. <strong>prefixLen++;</strong></p><p>98. <strong>byte[] prefixKey = new byte[(prefixLen + 1) >> 1];</strong></p><p>99. <strong>TrieKey ret = new TrieKey(prefixKey, (prefixLen &#x26; 1) == 0 ? 0 : 1,</strong></p><p>100. <strong>prefixLen == getLength() &#x26;&#x26; prefixLen == k.getLength() &#x26;&#x26; terminal &#x26;&#x26; k.isTerminal());</strong></p><p>101. <strong>for (int i = 0; i &#x3C; prefixLen; i++) {</strong></p><p>102. <strong>ret.setHex(i, k.getHex(i));</strong></p><p>103. <strong>}</strong></p><p>104. <strong>return ret;</strong></p><p>105. <strong>}</strong></p><p>106. </p><p>107. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsTjgGBv.png" alt="">    <strong>public TrieKey matchAndShift(TrieKey k) {</strong></p><p>108. <strong>int len = getLength();</strong></p><p>109. <strong>int kLen = k.getLength();</strong></p><p>110. <strong>if (len &#x3C; kLen) return null;</strong></p><p>111. </p><p>112. <strong>if ((off &#x26; 1) == (k.off &#x26; 1)) {</strong></p><p>113. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsyoRSq6.png" alt="">            <strong>// optimization to compare whole keys bytes</strong></p><p>114. <strong>if ((off &#x26; 1) == 1) {</strong></p><p>115. <strong>if (getHex(0) != k.getHex(0)) return null;</strong></p><p>116. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsvz5m4V.png" alt="">            <strong>}</strong></p><p>117. <strong>int idx1 = (off + 1) >> 1;</strong></p><p>118. <strong>int idx2 = (k.off + 1) >> 1;</strong></p><p>119. <strong>int l = kLen >> 1;</strong></p><p>120. <strong>for (int i = 0; i &#x3C; l; i++, idx1++, idx2++) {</strong></p><p>121. <strong>if (key[idx1] != k.key[idx2]) return null;</strong></p><p>122. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps4ucCzv.png" alt="">            <strong>}</strong></p><p>123. <strong>} else {</strong></p><p>124. <strong>for (int i = 0; i &#x3C; kLen; i++) {</strong></p><p>125. <strong>if (getHex(i) != k.getHex(i)) return null;</strong></p><p>126. <strong>}</strong></p><p>127. <strong>}</strong></p><p>128. <strong>return shift(kLen);</strong></p><p>129. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsc8sE5i.png" alt="">    <strong>}</strong></p><p>130. </p><p>131. <strong>public int getLength() {</strong></p><p>132. <strong>return (key.length &#x3C;&#x3C; 1) - off;</strong></p><p>133. <strong>}</strong></p><p>134. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps5E7oWL.png" alt=""></p><p>135. <strong>private void setHex(int idx, int hex) {</strong></p><p>136. <strong>int byteIdx = (off + idx) >> 1;</strong></p><p>137. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsOXPXfJ.png" alt="">        <strong>if (((off + idx) &#x26; 1) == 0) {</strong></p><p>138. <strong>key[byteIdx] &#x26;= 0x0F;</strong></p><p>139. <strong>key[byteIdx] |= hex &#x3C;&#x3C; 4;</strong></p><p>140. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsZd25xc.png" alt="">        <strong>} else {</strong></p><p>141. <strong>key[byteIdx] &#x26;= 0xF0;</strong></p><p>142. <strong>key[byteIdx] |= hex;</strong></p><p>143. <strong>}</strong></p><p>144. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsCryTV7.png" alt="">    <strong>}</strong></p><p>145. </p><p>146. <strong>public int getHex(int idx) {</strong></p><p>147. <strong>byte b = key[(off + idx) >> 1];</strong></p><p>148. <strong>return (((off + idx) &#x26; 1) == 0 ? (b >> 4) : b) &#x26; 0xF;</strong></p><p>149. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wpsSTSJxU.png" alt="">    <strong>}</strong></p><p>150. </p><p>151. <strong>public TrieKey concat(TrieKey k) {</strong></p><p>152. <strong>if (isTerminal()) throw new RuntimeException("Can' append to terminal key: " + this + " + " + k);</strong></p><p>153. <strong>int len = getLength();</strong></p><p>154. <strong>int kLen = k.getLength();</strong></p><p>155. <strong>int newLen = len + kLen;</strong></p><p>156. <strong>byte[] newKeyBytes = new byte[(newLen + 1) >> 1];</strong></p><p>157. <strong>TrieKey ret = new TrieKey(newKeyBytes, newLen &#x26; 1, k.isTerminal());</strong></p><p>158. <strong>for (int i = 0; i &#x3C; len; i++) {</strong></p><p>159. <strong>ret.setHex(i, getHex(i));</strong></p><p>160. <strong>}</strong></p><p>161. <strong>for (int i = 0; i &#x3C; kLen; i++) {</strong></p><p>162. <strong>ret.setHex(len + i, k.getHex(i));</strong></p><p>163. <strong>}</strong></p><p>164. <strong>return ret;</strong></p><p>165. <strong>}</strong></p><p>166. </p><p>167. <strong>@Override</strong></p><p>168. <strong>public boolean equals(Object obj) {</strong></p><p>169. <img src="file:///private/var/folders/9y/x_9ztblj0vb1mymmld_qgfzm0000gn/T/com.kingsoft.wpsoffice.mac/wps-qinpengfei/ksohtml/wps8OYoh8.png" alt="">        <strong>TrieKey k = (TrieKey) obj;</strong></p><p>170. <strong>int len = getLength();</strong></p><p>171. </p><p>172. <strong>if (len != k.getLength()) return false;</strong></p><p>173. <strong>// TODO can be optimized</strong></p><p>174. <strong>for (int i = 0; i &#x3C; len; i++) {</strong></p><p>175. <strong>if (getHex(i) != k.getHex(i)) return false;</strong></p><p>176. <strong>}</strong></p><p>177. <strong>return isTerminal() == k.isTerminal();</strong></p><p>178. <strong>}</strong></p><p>179. </p><p>180. <strong>@Override</strong></p><p>181. <strong>public String toString() {</strong></p><p>182. <strong>return toHexString(key).substring(off) + (isTerminal() ? "T" : "");</strong></p><p>183. <strong>}</strong></p><p>184. <strong>}</strong></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

&#x20;
